<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç§¯åˆ†æŒä¹…åŒ–æµ‹è¯•</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
    .test-section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #2196F3; }
    .result { margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 5px; }
    .error { background: #ffebee; color: #c62828; }
    button { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; }
    button:hover { background: #45a049; }
    .info { color: #666; font-size: 14px; margin: 5px 0; }
    pre { background: #263238; color: #aed581; padding: 15px; border-radius: 5px; overflow-x: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª ç§¯åˆ†æŒä¹…åŒ–å®Œæ•´æµ‹è¯•</h1>
    
    <div class="test-section">
      <h3>æµ‹è¯•æ­¥éª¤ï¼š</h3>
      <button onclick="testStep1()">1. æ³¨å†Œæ–°ç”¨æˆ·</button>
      <button onclick="testStep2()">2. æ¶ˆè´¹30ç§¯åˆ†</button>
      <button onclick="testStep3()">3. æ£€æŸ¥æ•°æ®åº“</button>
      <button onclick="testStep4()">4. æ¨¡æ‹Ÿé€€å‡ºç™»å½•</button>
      <button onclick="testStep5()">5. é‡æ–°ç™»å½•éªŒè¯</button>
      <button onclick="clearLocalStorage()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
    </div>

    <div id="results"></div>

    <div class="test-section">
      <h3>ğŸ“‹ localStorageçŠ¶æ€ï¼š</h3>
      <pre id="localStorage-state">æœªåŠ è½½</pre>
      <button onclick="showLocalStorage()">åˆ·æ–°æŸ¥çœ‹</button>
    </div>
  </div>

  <script>
    const API_BASE = 'http://115.190.137.87:8000';
    let testUserId = null;
    let testEmail = `test_${Date.now()}@example.com`;

    function log(message, isError = false) {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = isError ? 'result error' : 'result';
      div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
      results.appendChild(div);
      results.scrollTop = results.scrollHeight;
    }

    async function testStep1() {
      log('ğŸ”¹ æ­¥éª¤1ï¼šæ³¨å†Œæ–°ç”¨æˆ·...');
      try {
        const response = await fetch(`${API_BASE}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: testEmail,
            password: '123456',
            username: 'æµ‹è¯•ç”¨æˆ·'
          })
        });
        const data = await response.json();
        testUserId = data.user.id;
        log(`âœ… æ³¨å†ŒæˆåŠŸï¼ç”¨æˆ·ID: ${testUserId}, åˆå§‹ç§¯åˆ†: ${data.user.credits}`);
        log(`ğŸ“§ é‚®ç®±: ${testEmail}`);
      } catch (error) {
        log(`âŒ æ³¨å†Œå¤±è´¥: ${error.message}`, true);
      }
    }

    async function testStep2() {
      if (!testUserId) {
        log('âŒ è¯·å…ˆæ‰§è¡Œæ­¥éª¤1', true);
        return;
      }
      log('ğŸ”¹ æ­¥éª¤2ï¼šæ¶ˆè´¹30ç§¯åˆ†...');
      try {
        const response = await fetch(`${API_BASE}/api/credits/consume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: testUserId,
            amount: 30,
            action: 'æµ‹è¯•æ¶ˆè´¹',
            description: 'ç§¯åˆ†æŒä¹…åŒ–æµ‹è¯•'
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          log(`âŒ HTTP ${response.status}: ${errorText}`, true);
          return;
        }
        
        const data = await response.json();
        if (!data || data.credits === undefined) {
          log(`âŒ APIè¿”å›æ ¼å¼é”™è¯¯: ${JSON.stringify(data)}`, true);
          return;
        }
        
        log(`âœ… æ¶ˆè´¹æˆåŠŸï¼å‰©ä½™ç§¯åˆ†: ${data.credits}, æ¶ˆè´¹: ${data.consumed}`);
      } catch (error) {
        log(`âŒ æ¶ˆè´¹å¤±è´¥: ${error.message}`, true);
      }
    }

    async function testStep3() {
      if (!testUserId) {
        log('âŒ è¯·å…ˆæ‰§è¡Œæ­¥éª¤1', true);
        return;
      }
      log('ğŸ”¹ æ­¥éª¤3ï¼šæŸ¥è¯¢æ•°æ®åº“æœ€æ–°ç§¯åˆ†...');
      try {
        const response = await fetch(`${API_BASE}/api/credits/balance/${testUserId}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          log(`âŒ HTTP ${response.status}: ${errorText}`, true);
          return;
        }
        
        const data = await response.json();
        if (!data || data.credits === undefined) {
          log(`âŒ APIè¿”å›æ ¼å¼é”™è¯¯: ${JSON.stringify(data)}`, true);
          return;
        }
        
        log(`âœ… æ•°æ®åº“ç§¯åˆ†: ${data.credits}`);
        
        // æŸ¥è¯¢ç§¯åˆ†å†å²
        const historyResponse = await fetch(`${API_BASE}/api/credits/history/${testUserId}`);
        if (historyResponse.ok) {
          const historyData = await historyResponse.json();
          if (historyData && historyData.history) {
            log(`ğŸ“œ ç§¯åˆ†å†å²è®°å½•: ${historyData.history.length}æ¡`);
            historyData.history.forEach(h => {
              log(`   ${h.action}: ${h.amount > 0 ? '+' : ''}${h.amount} (ä½™é¢: ${h.balanceAfter})`);
            });
          }
        }
      } catch (error) {
        log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, true);
      }
    }

    async function testStep4() {
      log('ğŸ”¹ æ­¥éª¤4ï¼šæ¨¡æ‹Ÿé€€å‡ºç™»å½•ï¼ˆæ¸…é™¤localStorageï¼‰...');
      localStorage.clear();
      log('âœ… localStorageå·²æ¸…ç©º');
      showLocalStorage();
    }

    async function testStep5() {
      log('ğŸ”¹ æ­¥éª¤5ï¼šé‡æ–°ç™»å½•å¹¶éªŒè¯ç§¯åˆ†...');
      try {
        const response = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: testEmail,
            password: '123456'
          })
        });
        const data = await response.json();
        const credits = data.user.credits;
        log(`âœ… ç™»å½•æˆåŠŸï¼è¿”å›ç§¯åˆ†: ${credits}`);
        
        // æ¨¡æ‹Ÿå‰ç«¯storeä¿å­˜
        const mockStore = {
          user: data.user,
          isLoggedIn: true,
          credits: data.user.credits
        };
        localStorage.setItem('app-store', JSON.stringify({ state: mockStore }));
        log(`ğŸ’¾ å·²ä¿å­˜åˆ°localStorage`);
        
        // éªŒè¯
        if (credits === 490) {
          log(`ğŸ‰ ç§¯åˆ†æ­£ç¡®ï¼ä»520æ‰£é™¤30åä¸º490`, false);
        } else {
          log(`âš ï¸ ç§¯åˆ†å¼‚å¸¸ï¼æœŸæœ›490ï¼Œå®é™…${credits}`, true);
        }
        
        showLocalStorage();
      } catch (error) {
        log(`âŒ ç™»å½•å¤±è´¥: ${error.message}`, true);
      }
    }

    function showLocalStorage() {
      const state = document.getElementById('localStorage-state');
      const data = localStorage.getItem('app-store');
      if (data) {
        const parsed = JSON.parse(data);
        state.textContent = JSON.stringify(parsed, null, 2);
      } else {
        state.textContent = 'ç©ºï¼ˆæœªç™»å½•ï¼‰';
      }
    }

    function clearLocalStorage() {
      localStorage.clear();
      log('ğŸ—‘ï¸ localStorageå·²æ¸…ç©º');
      showLocalStorage();
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºlocalStorage
    showLocalStorage();
  </script>
</body>
</html>
