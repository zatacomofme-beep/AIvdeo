## 🎯 项目深度理解报告

### 📌 项目概述

**SoraDirector (AIvdeo)** 是一个专为电商产品设计的 **AI视频自动生成平台**,利用AI技术帮助用户快速创建专业的UGC风格产品推广视频。

---

### 🏗️ 核心架构

#### **技术栈**
- **前端**: React 18 + TypeScript + Vite + TailwindCSS v4 + Zustand
- **后端**: Python FastAPI + PostgreSQL + SQLAlchemy
- **AI服务**: 
  - GPT-4o/Gemini (脚本生成、对话)
  - Sora 2 (视频生成)
  - 云雾AI API (统一接口)
- **存储**: 火山云TOS (对象存储)

#### **部署架构**
- 前端: Vite开发服务器 (生产可部署到Vercel/Netlify)
- 后端: FastAPI服务 (部署在云服务器 115.190.137.87:8000)
- 数据库: PostgreSQL (火山云)
- 文件存储: 火山云TOS S3兼容存储

---

### 🎬 核心业务流程

项目实现了**4个核心阶段**的视频创作工作流:

#### **阶段1: 商品建模 (Product Modeling)**
```
用户操作:
1. 上传5张商品高清图片 → TOS存储
2. 填写商品信息(品名、类目、使用方式、卖点)
3. 保存到商品库

技术实现:
- 前端: CreateProductPanel组件
- API: POST /upload-image (上传到TOS)
- 数据库: products表存储
```

#### **阶段2: 选择角色 (Character Selection)**
```
用户操作:
1. 从已有角色中选择
2. 或AI生成新角色(输入国家、人种、年龄、性别)

技术实现:
- 前端: CharacterSelector组件
- API: POST /api/generate-character (GPT-4o生成角色描述)
- 数据库: characters表存储
```

#### **阶段3: 导演配置 (Director Settings)**
```
用户操作:
1. 选择投放国家(中国/美国/印尼/泰国等)
2. 选择视频语言(中文/英文/泰语/印尼语等)
3. 配置视频参数:
   - 方向: portrait(9:16竖屏) / landscape(16:9横屏)
   - 分辨率: 720p / 1080p
   - 时长: 15秒 / 25秒
   - 风格: UGC/专业展示/创意等

技术实现:
- 前端: DirectorPanel组件 (步骤3)
- 状态管理: videoConfig in store
```

#### **阶段4: 脚本生成与视频创作 (Scripting & Rendering)**
```
用户操作:
1. 点击"AI生成脚本" (消耗30积分)
   → GPT根据商品、角色、配置生成分镜脚本
2. 手动编辑脚本(可选)
3. 点击"生成视频" (消耗70积分)
   → Sora 2生成视频

技术实现:
- API脚本: POST /api/generate-script-ai
  - Prompt工程: prompts.py中的模板
  - 返回分镜JSON: [{time, scene, action, audio, emotion}]
  
- API视频: POST /generate-video
  - 参数: prompt, images[], orientation, size, duration
  - 异步任务: 返回task_id
  - 轮询状态: GET /api/video-task/{task_id}
  
- 数据库: videos表记录生成任务
```

---

### 💾 数据库设计

#### **7张核心表**

1. **users** - 用户系统
   ```sql
   - id, email, username, password_hash (bcrypt加密)
   - credits (积分系统)
   - role (user/admin)
   - wechat_openid (微信登录)
   ```

2. **products** - 商品库
   ```sql
   - id, user_id, name, category, usage
   - selling_points, image_urls (JSONB存储URL数组)
   ```

3. **characters** - 角色库
   ```sql
   - id, user_id, name, description
   - age, gender, style, tags (JSONB)
   - character_id (Sora角色ID)
   ```

4. **videos** - 视频记录
   ```sql
   - id, user_id, project_id
   - video_url, thumbnail_url
   - task_id (Sora任务ID)
   - status (processing/completed/failed)
   - prompt, script, product_name
   ```

5. **projects** - 项目上下文
   ```sql
   保存一次完整创作流程的所有数据
   - visual_img_url, character_prompt
   - script_json (JSONB), video_config (JSONB)
   - final_sora_prompt, sora_video_url
   ```

6. **saved_prompts** - 提示词库
   ```sql
   用户保存的脚本提示词
   ```

7. **credit_history** - 积分历史
   ```sql
   - action, amount, balance_after
   - 记录所有积分变动(生成脚本-30, 生成视频-70, 充值+N)
   ```

---

### 🎨 UI/UX设计

#### **设计风格** - **赛博朋克暗色系 + 黄色强调**
```
- 主背景: slate-900/slate-950 (深黑)
- 卡片: glass-card (毛玻璃效果 backdrop-blur)
- 主色调: 黄色渐变 (from-yellow-400 to-amber-500)
- 辅助色: cyan, purple, blue (用于不同功能区)
- 动效: 流光、呼吸、浮动动画
```

#### **核心组件**

1. **App.tsx** - 主框架
   ```
   - TopBar: 顶部栏(积分显示、用户中心)
   - Sidebar: 左侧导航(工作室/我的视频/我的商品/我的角色/广场/管理员)
   - MainWorkspace: 主工作区
   - DirectorPanel: AI导演弹窗(4步骤表单)
   - CreateProductPanel: 创建商品弹窗
   - LoginModal: 登录/注册弹窗
   - RechargeModal: 充值弹窗
   ```

2. **状态管理 (Zustand)**
   ```typescript
   useStore: 
   - user (当前登录用户)
   - credits (积分)
   - savedProducts (商品列表)
   - myCharacters (角色列表)
   - myVideos (视频列表)
   - uploadedImages (当前上传的图片)
   - script (当前脚本)
   - videoConfig (视频配置)
   ```

---

### 🔌 API集成

#### **后端main.py核心接口**

| 接口 | 方法 | 功能 | 消耗积分 |
|------|------|------|----------|
| `/upload-image` | POST | 上传图片到TOS | 0 |
| `/api/register` | POST | 用户注册(初始100积分) | 0 |
| `/api/login` | POST | 用户登录 | 0 |
| `/api/generate-character` | POST | AI生成角色 | 0 |
| `/create-character` | POST | 保存角色到数据库 | 0 |
| `/api/generate-script-ai` | POST | AI生成脚本 | 30 |
| `/generate-video` | POST | Sora生成视频 | 70 |
| `/api/video-task/{id}` | GET | 查询视频状态 | 0 |
| `/api/credits/balance/{user_id}` | GET | 查询积分 | 0 |
| `/api/credits/consume` | POST | 消费积分 | - |
| `/api/credits/recharge` | POST | 充值积分 | - |

#### **Prompt工程 (prompts.py)**

项目使用**精心设计的Prompt模板**:

1. **CHARACTER_GENERATION_PROMPT** - 角色生成
   ```
   - 输入: 国家、人种、年龄、性别
   - 输出: JSON格式角色描述
   - 约束: 真实普通人,非明星/模特
   ```

2. **SCRIPT_GENERATION_PROMPT** - 脚本生成
   ```
   - 输入: 商品信息、角色、语言、时长
   - 输出: 分镜JSON [{time, scene, action, audio, emotion}]
   - 关键规则: 
     * scene/action/emotion用英文(Sora理解)
     * audio用目标语言(泰语/印尼语等)
     * 强调UGC风格,避免广告感
   ```

3. **AI_DIRECTOR_SYSTEM_PROMPT** - 对话导演
   ```
   - 角色定位: 智能导演助手
   - 功能: 根据对话历史,自动判断阶段,引导用户
   - 输出: 结构化数据 + 自然对话
   ```

---

### 🎯 关键技术亮点

#### **1. 多模态AI应用**
```python
# backend/main.py
async def chat_with_ai(prompt, system_prompt, image_url, history):
    # 支持图片+文本混合输入
    messages.append({
        "role": "user",
        "content": [
            {"type": "text", "text": prompt},
            {"type": "image_url", "image_url": {"url": base64_image}}
        ]
    })
```

#### **2. 火山云TOS集成**
```python
# 使用Virtual-Host模式访问
# URL格式: https://sora-2.tos-cn-beijing.volces.com/uploads/xxx
tos_client = tos.TosClientV2(
    ak=TOS_ACCESS_KEY,
    sk=TOS_SECRET_KEY,
    endpoint="https://tos-cn-beijing.volces.com",
    region="cn-beijing"
)
```

#### **3. 异步视频生成 + 轮询**
```typescript
// 前端轮询逻辑
const pollVideoStatus = async (taskId: string) => {
  const pollInterval = setInterval(async () => {
    const status = await api.queryVideoTask(taskId);
    if (status.status === 'completed') {
      // 更新UI,停止轮询
    }
  }, 3000); // 每3秒查询
};
```

#### **4. 积分系统**
```
- bcrypt密码加密
- 交易记录: credit_history表
- 实时同步: 前端store + 后端数据库双向同步
- 消费规则:
  * 生成脚本: -30积分
  * 生成视频: -70积分
  * 充值: +N积分
```

---

### 📂 项目结构总结

```
AIvdeo/
├── src/                         # 前端源码
│   ├── app/
│   │   ├── components/          # React组件
│   │   │   ├── Sidebar.tsx      # 导航栏
│   │   │   ├── TopBar.tsx       # 顶栏
│   │   │   ├── MainWorkspace.tsx # 工作区
│   │   │   ├── DirectorPanel.tsx # AI导演(4步骤)
│   │   │   ├── CreateProductPanel.tsx # 创建商品
│   │   │   └── CharacterSelector.tsx # 选择角色
│   │   ├── lib/
│   │   │   ├── store.ts         # Zustand状态
│   │   │   └── utils.ts         # 工具函数
│   │   └── App.tsx              # 主应用
│   ├── lib/
│   │   └── api.ts               # API封装
│   └── main.tsx                 # 入口
├── backend/                     # 后端源码
│   ├── main.py                  # FastAPI主文件(2392行)
│   ├── database.py              # SQLAlchemy模型
│   ├── prompts.py               # AI Prompt模板
│   ├── init_db.py               # 数据库初始化
│   ├── requirements.txt         # Python依赖
│   └── create_tables.sql        # SQL建表脚本
├── package.json                 # 前端依赖
├── vite.config.ts               # Vite配置
├── tailwind.config.js           # TailwindCSS配置
└── README.md                    # 项目文档
```

---

### 🎯 业务逻辑总结

1. **用户注册/登录** → 初始100积分
2. **创建商品** → 上传图片+填写信息 → 保存到商品库
3. **开始创作** → 
   - 选择商品
   - 选择/生成角色
   - 配置视频参数
   - AI生成脚本(-30积分)
   - 生成视频(-70积分)
4. **视频管理** → 我的视频页面查看所有生成的视频
5. **资产管理** → 我的商品/我的角色/我的提示词
6. **积分管理** → 查看余额/充值/消费历史

---

### 🚀 技术创新点

1. **表单驱动 + AI辅助** - 简化复杂的视频创作流程
2. **多语言支持** - 脚本生成支持10+语言
3. **Prompt工程** - 精心设计的模板确保输出质量
4. **异步架构** - 视频生成不阻塞UI
5. **状态持久化** - localStorage + PostgreSQL双重保存
6. **UGC风格强调** - 避免广告感,提升转化率

---

### 💡 我的理解总结

这是一个**完整的商业级AI视频生成平台**,核心价值在于:

✅ **降低视频创作门槛** - 不需要专业摄影/剪辑技能  
✅ **多语言市场支持** - 适合跨境电商  
✅ **AI智能辅助** - 从角色到脚本全程AI生成  
✅ **标准化工作流** - 4步骤清晰高效  
✅ **完整的技术栈** - 前后端分离,数据库持久化,对象存储  

**适用场景**: TikTok/Shorts/Reels等短视频平台的电商产品推广视频批量生成。

---

这就是我对项目的深度理解!有任何具体问题或需要深入某个模块,随时告诉我! 🎬✨