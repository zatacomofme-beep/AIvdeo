# ðŸ”„ äº‘æœåŠ¡å™¨æŒä¹…åŒ–è¿è¡Œé…ç½®æŒ‡å—

ç¡®ä¿æœåŠ¡å™¨é‡å¯åŽï¼Œæ‰€æœ‰æœåŠ¡è‡ªåŠ¨å¯åŠ¨å¹¶æ¢å¤è¿è¡Œã€‚

---

## âœ… å½“å‰å·²é…ç½®çš„æŒä¹…åŒ–

éƒ¨ç½²æ—¶å·²ç»è‡ªåŠ¨é…ç½®äº†ä»¥ä¸‹æœåŠ¡çš„æŒä¹…åŒ–ï¼š

1. âœ… **Nginx** - å·²è®¾ç½®å¼€æœºè‡ªå¯
2. âœ… **PM2** - å·²ä¿å­˜è¿›ç¨‹åˆ—è¡¨ï¼ˆ`pm2 save`ï¼‰

ä½†è¿˜éœ€è¦é…ç½® **PM2 å¼€æœºè‡ªå¯**ã€‚

---

## ðŸš€ å®Œæ•´æŒä¹…åŒ–é…ç½®æ­¥éª¤

### 1ï¸âƒ£ é…ç½® PM2 å¼€æœºè‡ªå¯

```bash
ssh root@115.190.137.87

# ç”Ÿæˆ PM2 å¯åŠ¨è„šæœ¬
pm2 startup

# ä¼šè¾“å‡ºç±»ä¼¼è¿™æ ·çš„å‘½ä»¤ï¼Œå¤åˆ¶å¹¶æ‰§è¡Œï¼š
# sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u root --hp /root

# ä¿å­˜å½“å‰ PM2 è¿›ç¨‹åˆ—è¡¨
pm2 save

# éªŒè¯é…ç½®
systemctl status pm2-root
```

### 2ï¸âƒ£ ç¡®è®¤ Nginx å¼€æœºè‡ªå¯

```bash
# å¯ç”¨ Nginx å¼€æœºè‡ªå¯ï¼ˆéƒ¨ç½²æ—¶å·²æ‰§è¡Œï¼‰
systemctl enable nginx

# éªŒè¯çŠ¶æ€
systemctl is-enabled nginx
# åº”è¯¥æ˜¾ç¤º: enabled
```

### 3ï¸âƒ£ æµ‹è¯•æœåŠ¡å™¨é‡å¯æ¢å¤

```bash
# é‡å¯æœåŠ¡å™¨æµ‹è¯•
reboot

# ç­‰å¾… 1-2 åˆ†é’ŸåŽé‡æ–°ç™»å½•
ssh root@115.190.137.87

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status
systemctl status nginx

# æµ‹è¯•ç½‘ç«™è®¿é—®
curl -I https://semopic.com
```

---

## ðŸ“‹ åˆ›å»ºä¸€é”®é…ç½®è„šæœ¬

```bash
ssh root@115.190.137.87

cat > /root/setup_persistence.sh << 'EOF'
#!/bin/bash

set -e

echo "=========================================="
echo "é…ç½®æœåŠ¡å™¨æŒä¹…åŒ–è¿è¡Œ"
echo "=========================================="

# 1. é…ç½® PM2 å¼€æœºè‡ªå¯
echo "[1/4] é…ç½® PM2 å¼€æœºè‡ªå¯..."
pm2 startup systemd -u root --hp /root
pm2 save
echo "âœ“ PM2 å¼€æœºè‡ªå¯å·²é…ç½®"

# 2. ç¡®è®¤ Nginx å¼€æœºè‡ªå¯
echo "[2/4] ç¡®è®¤ Nginx å¼€æœºè‡ªå¯..."
systemctl enable nginx
echo "âœ“ Nginx å¼€æœºè‡ªå¯å·²å¯ç”¨"

# 3. é…ç½®é˜²ç«å¢™ï¼ˆå¦‚æžœå®‰è£…äº†ï¼‰
echo "[3/4] é…ç½®é˜²ç«å¢™..."
if command -v firewall-cmd &> /dev/null; then
    systemctl enable firewalld
    echo "âœ“ é˜²ç«å¢™å¼€æœºè‡ªå¯å·²å¯ç”¨"
else
    echo "âš  æœªæ£€æµ‹åˆ° firewalldï¼Œè·³è¿‡"
fi

# 4. éªŒè¯é…ç½®
echo "[4/4] éªŒè¯é…ç½®..."
echo ""
echo "PM2 çŠ¶æ€:"
systemctl is-enabled pm2-root 2>/dev/null && echo "  âœ“ pm2-root: enabled" || echo "  âš  pm2-root: æœªé…ç½®"

echo ""
echo "Nginx çŠ¶æ€:"
systemctl is-enabled nginx && echo "  âœ“ nginx: enabled" || echo "  âœ— nginx: æœªå¯ç”¨"

echo ""
echo "å½“å‰è¿è¡Œçš„æœåŠ¡:"
pm2 status

echo ""
echo "=========================================="
echo "âœ¨ æŒä¹…åŒ–é…ç½®å®Œæˆï¼"
echo "=========================================="
echo ""
echo "å»ºè®®æ“ä½œï¼š"
echo "  1. æ‰§è¡Œ 'reboot' é‡å¯æœåŠ¡å™¨æµ‹è¯•"
echo "  2. é‡å¯åŽæ£€æŸ¥æœåŠ¡çŠ¶æ€"
echo "  3. è®¿é—® https://semopic.com éªŒè¯"

EOF

chmod +x /root/setup_persistence.sh

# æ‰§è¡Œè„šæœ¬
bash /root/setup_persistence.sh
```

---

## ðŸ” éªŒè¯æŒä¹…åŒ–é…ç½®

### æ£€æŸ¥æ‰€æœ‰æœåŠ¡çš„å¼€æœºè‡ªå¯çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å·²å¯ç”¨çš„æœåŠ¡
systemctl list-unit-files | grep enabled | grep -E 'nginx|pm2'

# æŸ¥çœ‹ PM2 æœåŠ¡çŠ¶æ€
systemctl status pm2-root

# æŸ¥çœ‹ Nginx æœåŠ¡çŠ¶æ€
systemctl status nginx

# æŸ¥çœ‹ PM2 è¿›ç¨‹åˆ—è¡¨
pm2 status

# æŸ¥çœ‹ PM2 ä¿å­˜çš„é…ç½®
cat /root/.pm2/dump.pm2
```

---

## ðŸ›¡ï¸ é¢å¤–çš„æŒä¹…åŒ–ä¿éšœæŽªæ–½

### 1. é…ç½®è¿›ç¨‹ç›‘æŽ§è‡ªåŠ¨é‡å¯

PM2 å·²ç»å†…ç½®äº†è¿›ç¨‹å´©æºƒè‡ªåŠ¨é‡å¯åŠŸèƒ½ï¼Œä½†å¯ä»¥è°ƒæ•´é‡å¯ç­–ç•¥ï¼š

```bash
# æ›´æ–° PM2 é…ç½®ï¼ˆæœ€å¤§é‡å¯æ¬¡æ•°ç­‰ï¼‰
pm2 start /root/backend/venv/bin/uvicorn --name aivideo-backend \
  -- app.main:app --host 0.0.0.0 --port 8000 \
  --max-restarts 10 \
  --min-uptime 5000

pm2 save
```

### 2. é…ç½®ç³»ç»Ÿæ—¥å¿—ä¿ç•™

```bash
# é…ç½® PM2 æ—¥å¿—è½®è½¬
pm2 install pm2-logrotate

# è®¾ç½®æ—¥å¿—ä¿ç•™ç­–ç•¥
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true
```

### 3. é…ç½®æ•°æ®åº“è¿žæŽ¥æ± ä¿æŒ

åœ¨ `/root/backend/.env` ä¸­ç¡®ä¿æœ‰ä»¥ä¸‹é…ç½®ï¼š

```env
# æ•°æ®åº“è¿žæŽ¥æ± é…ç½®
DATABASE_URL=postgresql://ç”¨æˆ·å:å¯†ç @192.168.19.67:5432/aivideo?pool_size=10&max_overflow=20
```

### 4. é…ç½® Nginx è¿žæŽ¥ä¿æŒ

Nginx é…ç½®å·²åŒ…å«åœ¨ `/etc/nginx/conf.d/semopic.conf` ä¸­ï¼š

```nginx
# ä¿æŒè¿žæŽ¥
keepalive_timeout 65;
keepalive_requests 100;
```

---

## ðŸ”„ å®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆå¯é€‰ï¼‰

### é…ç½®è‡ªåŠ¨æ¸…ç†æ—¥å¿—

```bash
# åˆ›å»ºæ¸…ç†è„šæœ¬
cat > /root/cleanup_logs.sh << 'EOF'
#!/bin/bash
# æ¸…ç† 7 å¤©å‰çš„ PM2 æ—¥å¿—
find /root/.pm2/logs -type f -mtime +7 -delete
# æ¸…ç† Nginx æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘ 30 å¤©ï¼‰
find /var/log/nginx -type f -name "*.log.*" -mtime +30 -delete
echo "æ—¥å¿—æ¸…ç†å®Œæˆ: $(date)"
EOF

chmod +x /root/cleanup_logs.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * 0 /root/cleanup_logs.sh >> /var/log/cleanup.log 2>&1") | crontab -
```

### é…ç½®è‡ªåŠ¨å¤‡ä»½ .env é…ç½®

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /root/backup_config.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/root/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# å¤‡ä»½ .env æ–‡ä»¶
cp /root/backend/.env $BACKUP_DIR/.env_$DATE

# ä¿ç•™æœ€è¿‘ 30 å¤©çš„å¤‡ä»½
find $BACKUP_DIR -type f -mtime +30 -delete

echo "é…ç½®å¤‡ä»½å®Œæˆ: $(date)"
EOF

chmod +x /root/backup_config.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œï¼‰
(crontab -l 2>/dev/null; echo "0 3 * * * /root/backup_config.sh >> /var/log/backup.log 2>&1") | crontab -
```

---

## ðŸ“Š ç›‘æŽ§æœåŠ¡å¥åº·çŠ¶æ€

### åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬

```bash
cat > /root/health_check.sh << 'EOF'
#!/bin/bash

echo "=========================================="
echo "æœåŠ¡å¥åº·æ£€æŸ¥ - $(date)"
echo "=========================================="

# æ£€æŸ¥ PM2 æœåŠ¡
echo ""
echo "1. PM2 æœåŠ¡çŠ¶æ€:"
pm2 status

# æ£€æŸ¥ Nginx æœåŠ¡
echo ""
echo "2. Nginx æœåŠ¡çŠ¶æ€:"
systemctl status nginx | head -5

# æ£€æŸ¥åŽç«¯ API
echo ""
echo "3. åŽç«¯ API å¥åº·æ£€æŸ¥:"
curl -s http://localhost:8000/api/health | head -3 || echo "âŒ åŽç«¯ API æ— å“åº”"

# æ£€æŸ¥ç½‘ç«™è®¿é—®
echo ""
echo "4. ç½‘ç«™è®¿é—®æ£€æŸ¥:"
curl -I -s https://semopic.com | head -1 || echo "âŒ ç½‘ç«™æ— æ³•è®¿é—®"

# æ£€æŸ¥ç£ç›˜ç©ºé—´
echo ""
echo "5. ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
df -h | grep -E "Filesystem|/$"

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
echo ""
echo "6. å†…å­˜ä½¿ç”¨æƒ…å†µ:"
free -h

echo ""
echo "=========================================="
echo "æ£€æŸ¥å®Œæˆ"
echo "=========================================="
EOF

chmod +x /root/health_check.sh
```

è¿è¡Œå¥åº·æ£€æŸ¥ï¼š

```bash
bash /root/health_check.sh
```

---

## âœ… æŒä¹…åŒ–é…ç½®æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹é…ç½®åŽï¼Œæ‚¨çš„æœåŠ¡å™¨å°†å®Œå…¨æŒä¹…åŒ–è¿è¡Œï¼š

- [ ] PM2 å¼€æœºè‡ªå¯å·²é…ç½®
- [ ] Nginx å¼€æœºè‡ªå¯å·²å¯ç”¨
- [ ] PM2 è¿›ç¨‹åˆ—è¡¨å·²ä¿å­˜
- [ ] å·²æµ‹è¯•æœåŠ¡å™¨é‡å¯æ¢å¤
- [ ] ç½‘ç«™å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] é…ç½®æ–‡ä»¶å·²å¤‡ä»½
- [ ] æ—¥å¿—è½®è½¬å·²é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] å®šæ—¶ä»»åŠ¡å·²è®¾ç½®ï¼ˆå¯é€‰ï¼‰

---

## ðŸš¨ æ•…éšœæ¢å¤

å¦‚æžœæœåŠ¡å™¨é‡å¯åŽæœåŠ¡æœªå¯åŠ¨ï¼š

### 1. æ‰‹åŠ¨å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# å¯åŠ¨ Nginx
systemctl start nginx

# å¯åŠ¨ PM2
pm2 resurrect

# å¦‚æžœ resurrect å¤±è´¥ï¼Œæ‰‹åŠ¨å¯åŠ¨
cd /root/backend
pm2 start venv/bin/uvicorn --name aivideo-backend -- app.main:app --host 0.0.0.0 --port 8000
pm2 save
```

### 2. æ£€æŸ¥å¯åŠ¨æ—¥å¿—

```bash
# æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨æ—¥å¿—
journalctl -xe

# æŸ¥çœ‹ PM2 æ—¥å¿—
pm2 logs --err

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
tail -50 /var/log/nginx/error.log
```

---

## ðŸ’¡ æœ€ä½³å®žè·µå»ºè®®

1. **å®šæœŸå¤‡ä»½**ï¼šæ¯å‘¨å¤‡ä»½ `.env` å’Œæ•°æ®åº“
2. **ç›‘æŽ§æ—¥å¿—**ï¼šå®šæœŸæŸ¥çœ‹ `pm2 logs` æ£€æŸ¥é”™è¯¯
3. **æµ‹è¯•é‡å¯**ï¼šæ¯æœˆæµ‹è¯•ä¸€æ¬¡æœåŠ¡å™¨é‡å¯æ¢å¤
4. **æ›´æ–°ç»´æŠ¤**ï¼šå®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–åŒ…
5. **èµ„æºç›‘æŽ§**ï¼šå…³æ³¨ CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨æƒ…å†µ

---

ðŸŽ‰ é…ç½®å®ŒæˆåŽï¼Œæ‚¨çš„æœåŠ¡å™¨å°†å®žçŽ°çœŸæ­£çš„æŒä¹…åŒ–è¿è¡Œï¼
