# 🚀 部署数据库版本 - 完整指南

## ✅ 已完成的工作

1. ✅ 数据库 `AIvdeo` 已创建
2. ✅ 7 个数据表已创建
3. ✅ 白名单已配置
4. ✅ 数据库连接测试成功
5. ✅ `main.py` 已添加数据库导入和启动检测

---

## 📦 需要上传到服务器的文件

使用 WinSCP 上传以下文件到 `/root/backend/`：

```
✅ .env              （数据库配置）
✅ database.py       （数据库模型，已修复）
✅ main.py           （已添加数据库支持，需要覆盖）
✅ requirements.txt  （包含数据库依赖）
```

---

## 🔧 在云服务器上执行的命令

### 步骤 1：上传文件后，SSH 登录服务器

```bash
ssh root@你的云服务器IP
```

### 步骤 2：进入项目目录

```bash
cd /root/backend
```

### 步骤 3：确认数据库依赖已安装

```bash
# 如果之前没安装，执行：
pip3 install psycopg2-binary sqlalchemy -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 步骤 4：测试数据库连接

```bash
python3 -c "from database import test_connection; test_connection()"
```

**预期输出：**
```
[DATABASE] 正在测试数据库连接...
[DATABASE] ✓ 数据库连接成功！
```

### 步骤 5：停止旧服务

```bash
pkill -f "uvicorn main:app"
```

### 步骤 6：启动新服务

```bash
nohup uvicorn main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
```

### 步骤 7：查看启动日志

```bash
tail -100 server.log
```

**预期看到：**
```
================================================================================
[DATABASE] 正在初始化数据库连接...
================================================================================
[DATABASE] 正在连接到数据库...
[DATABASE] Host: 192.168.19.67:5432
[DATABASE] Database: AIvdeo
[DATABASE] User: alizabos
[DATABASE] 正在测试数据库连接...
[DATABASE] ✓ 数据库连接成功！
[DATABASE] 数据将保存到 PostgreSQL
================================================================================

INFO:     Started server process [xxxxx]
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

### 步骤 8：测试 API

```bash
curl http://localhost:8000/health

# 应该返回
{"status":"ok"}
```

---

## 📊 当前状态说明

### ✅ 已完成

1. **数据库连接** - 启动时会自动测试连接
2. **数据库导入** - `main.py` 已导入数据库模块
3. **启动检测** - 服务启动时会显示数据库连接状态

### ⏳ 下一步（可选）

**当前版本：** `main.py` 已添加数据库支持，但大部分业务逻辑还在使用内存数据

**如需完全迁移到数据库：**
- 需要逐步替换所有内存操作为数据库操作
- 实现用户注册/登录 API
- 实现视频、商品等数据的数据库 CRUD

---

## 🎯 快速验证清单

执行完上述步骤后，验证以下几点：

- [ ] 服务成功启动（日志显示 `Uvicorn running`）
- [ ] 数据库连接成功（日志显示 `✓ 数据库连接成功`）
- [ ] 健康检查通过（`curl http://localhost:8000/health` 返回 ok）
- [ ] 没有错误日志

---

## 🆘 故障排查

### 问题 1：数据库连接失败

**日志显示：**
```
[DATABASE] ✗ 数据库连接失败
```

**解决：**
1. 检查 `.env` 文件是否正确上传
2. 检查白名单配置
3. 运行：`python3 -c "from database import test_connection; test_connection()"`

### 问题 2：服务启动失败

**解决：**
```bash
# 查看详细错误
cat server.log

# 前台运行查看错误
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 问题 3：端口被占用

**解决：**
```bash
# 查找占用端口的进程
lsof -i :8000

# 杀死进程
kill -9 <PID>
```

---

## 📝 重要提示

1. **数据库已就绪** - 所有表已创建，可以直接使用
2. **白名单已配置** - VPC 内网访问已允许
3. **当前是混合模式** - 数据库已连接，但业务逻辑还需逐步迁移

---

## 🎉 部署成功标志

当您看到以下日志，说明部署成功：

```
[DATABASE] ✓ 数据库连接成功！
[DATABASE] 数据将保存到 PostgreSQL
INFO:     Uvicorn running on http://0.0.0.0:8000
```

并且：
- ✅ `curl http://localhost:8000/health` 返回 `{"status":"ok"}`
- ✅ 服务日志没有错误
- ✅ 数据库可以正常查询

---

**现在开始部署吧！** 🚀
