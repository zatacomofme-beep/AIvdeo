# 🚀 AIvdeo 云服务器部署完整指南

> **您的环境**: 云服务器 + 火山云 RDS PostgreSQL（同VPC内网）

---

## 📦 第一步：准备上传文件

### 需要上传到云服务器的文件清单：

```
backend/
  ├── .env                    ✨ 数据库配置（已优化为私网地址）
  ├── database.py             ✨ 数据库模型定义
  ├── init_db.py              ✨ 数据库初始化脚本
  ├── requirements.txt        ✅ 依赖列表（已更新）
  └── setup_database.sh       🔧 自动配置脚本（可选）
```

---

## 💻 第二步：上传文件到服务器

### 方法一：使用 WinSCP（推荐Windows用户）

1. 打开 WinSCP
2. 连接到您的云服务器
3. 导航到 `/root/soradirector-backend/` 目录
4. 拖拽以下文件到服务器：
   - `.env`
   - `database.py`
   - `init_db.py`
   - `requirements.txt`
   - `setup_database.sh`（可选）

### 方法二：使用 scp 命令

打开本地命令行，在 `backend` 目录下执行：

```bash
# 替换成您的云服务器IP
scp .env database.py init_db.py requirements.txt setup_database.sh \
    root@你的云服务器IP:/root/soradirector-backend/
```

---

## 🔧 第三步：SSH登录云服务器

```bash
ssh root@你的云服务器IP
```

---

## ⚙️ 第四步：配置数据库

### 自动配置（推荐）

如果您上传了 `setup_database.sh`：

```bash
cd /root/soradirector-backend
chmod +x setup_database.sh
./setup_database.sh
```

### 手动配置

如果没有上传自动脚本，手动执行以下命令：

```bash
# 1. 进入项目目录
cd /root/soradirector-backend

# 2. 查看当前Python版本
python3 --version

# 3. 安装数据库依赖
pip3 install psycopg2-binary==2.9.9 sqlalchemy==2.0.25 alembic==1.13.1

# 或者使用国内镜像（更快）
pip3 install psycopg2-binary sqlalchemy alembic \
  -i https://pypi.tuna.tsinghua.edu.cn/simple

# 4. 验证.env配置
cat .env | grep DB_

# 应该看到（确认使用私网地址）：
# DB_HOST=192.168.19.67
# DB_PORT=5432
# DB_NAME=AIvdeo
# DB_USER=alizabos
# DB_PASSWORD=993124078King

# 5. 运行数据库初始化脚本
python3 init_db.py
```

---

## ✅ 第五步：验证数据库初始化

### 预期输出：

```
============================================================
AIvdeo 数据库初始化脚本
============================================================

步骤 1/3: 测试数据库连接...
[DATABASE] 正在连接到数据库...
[DATABASE] Host: 192.168.19.67:5432
[DATABASE] Database: AIvdeo
[DATABASE] User: alizabos
[DATABASE] 正在测试数据库连接...
[DATABASE] ✓ 数据库连接成功！
✓ 数据库连接成功！

步骤 2/3: 检查现有表...
没有发现已存在的表

步骤 3/3: 创建数据库表...
[DATABASE] 正在创建数据库表...
[DATABASE] ✓ 数据库表创建成功！
[DATABASE] 已创建以下表：
  - users (用户表)
  - products (商品表)
  - projects (项目表)
  - videos (视频表)
  - characters (角色表)
  - saved_prompts (提示词表)
  - credit_history (积分历史表)

============================================================
🎉 数据库初始化成功！
============================================================
```

### 如果遇到错误：

#### 错误1：连接超时
```
psycopg2.OperationalError: could not connect to server
```
**解决**：
- 检查云服务器安全组是否允许访问 RDS
- 确认 RDS 白名单包含云服务器的内网IP
- 确认使用的是私网地址 `192.168.19.67`

#### 错误2：认证失败
```
psycopg2.OperationalError: FATAL: password authentication failed
```
**解决**：
- 检查 `.env` 文件中的密码是否正确
- 确认用户名 `alizabos` 拼写正确

#### 错误3：数据库不存在
```
psycopg2.OperationalError: FATAL: database "AIvdeo" does not exist
```
**解决**：
- 在火山云控制台创建数据库 `AIvdeo`
- 或使用 psql 创建：
```bash
PGPASSWORD=993124078King psql \
  -h 192.168.19.67 \
  -U alizabos \
  -d postgres \
  -c "CREATE DATABASE AIvdeo;"
```

---

## 🔍 第六步：验证表创建成功

### 方法一：使用 psql 命令

```bash
# 查看所有表
PGPASSWORD=993124078King psql \
  -h 192.168.19.67 \
  -U alizabos \
  -d AIvdeo \
  -c "\dt"

# 查看 users 表结构
PGPASSWORD=993124078King psql \
  -h 192.168.19.67 \
  -U alizabos \
  -d AIvdeo \
  -c "\d users"
```

### 方法二：使用 Python 测试

```bash
# 创建测试脚本
cat > test_db.py << 'EOF'
from database import test_connection, SessionLocal, User
import uuid

# 测试连接
if test_connection():
    print("\n✓ 数据库连接正常\n")
    
    # 测试创建用户
    db = SessionLocal()
    try:
        test_user = User(
            id=str(uuid.uuid4()),
            email="test@example.com",
            username="测试用户",
            credits=520,
            role="user"
        )
        db.add(test_user)
        db.commit()
        print("✓ 成功创建测试用户")
        
        # 查询用户
        users = db.query(User).all()
        print(f"✓ 当前用户数量: {len(users)}")
        
        # 删除测试用户
        db.delete(test_user)
        db.commit()
        print("✓ 测试用户已删除\n")
    finally:
        db.close()
else:
    print("\n✗ 数据库连接失败\n")
EOF

# 运行测试
python3 test_db.py
```

---

## 🔄 第七步：更新 main.py 使用数据库

现在数据库已配置好，需要更新后端代码以使用真实数据库。

### 选项一：我帮您更新（推荐）

告诉我"开始更新 main.py"，我会帮您：
- ✅ 导入数据库模块
- ✅ 添加用户注册/登录 API
- ✅ 替换内存数据为数据库操作
- ✅ 实现数据持久化

### 选项二：手动更新

稍后自己修改 `main.py`

---

## 🚀 第八步：重启后端服务

### 停止现有服务

```bash
# 查找并停止 uvicorn 进程
pkill -f "uvicorn main:app"

# 或者找到进程ID
ps aux | grep uvicorn
kill -9 <进程ID>
```

### 启动新服务

```bash
# 方法1：后台运行
nohup uvicorn main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &

# 方法2：使用 start.sh 脚本
./start.sh

# 方法3：前台运行（调试用）
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 查看服务日志

```bash
# 实时查看日志
tail -f server.log

# 查看启动信息
tail -100 server.log | grep DATABASE
```

---

## 📊 预期看到的数据库连接日志

启动服务后，应该看到类似输出：

```
[DATABASE] 正在连接到数据库...
[DATABASE] Host: 192.168.19.67:5432
[DATABASE] Database: AIvdeo
[DATABASE] User: alizabos
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

## 🧪 第九步：测试 API

### 测试健康检查

```bash
curl http://localhost:8000/health
# 预期输出: {"status":"ok"}
```

### 测试数据库相关API（更新main.py后）

```bash
# 测试用户注册
curl -X POST http://localhost:8000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "测试用户",
    "password": "123456"
  }'

# 测试用户登录
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "123456"
  }'
```

---

## 📋 完成检查清单

部署完成后，请确认：

- [ ] ✅ 文件已上传到云服务器 `/root/soradirector-backend/`
- [ ] ✅ `.env` 使用私网地址 `192.168.19.67`
- [ ] ✅ 数据库依赖已安装（psycopg2-binary, sqlalchemy）
- [ ] ✅ `init_db.py` 运行成功
- [ ] ✅ 7个表已在 RDS 中创建
- [ ] ✅ 数据库连接测试通过
- [ ] ⏳ `main.py` 已更新使用数据库（待完成）
- [ ] ⏳ 后端服务已重启
- [ ] ⏳ API 测试通过

---

## 🎯 下一步：更新 main.py

数据库配置完成后，告诉我：

**"开始更新 main.py"**

我会帮您：
1. 导入数据库模块
2. 添加用户注册/登录功能
3. 实现真实的数据持久化
4. 替换所有内存操作为数据库操作

---

## 📞 需要帮助？

如果遇到问题，请提供：
- 执行的命令
- 完整的错误信息
- 服务器日志输出

我会立即帮您解决！🚀

---

**准备好了吗？让我们继续完成部署！** 💪
