# ç§¯åˆ†æ‰£é™¤å’Œå……å€¼åŠŸèƒ½å®ç°è¯´æ˜

## âœ… å·²å®Œæˆ

ç§¯åˆ†ç®¡ç†ç³»ç»Ÿå·²å®Œå–„ï¼ŒåŒ…æ‹¬ï¼š
1. âœ… ç§¯åˆ†æ¶ˆè´¹ï¼ˆæ‰£é™¤ï¼‰
2. âœ… ç§¯åˆ†å……å€¼ï¼ˆå¢åŠ ï¼‰
3. âœ… ç§¯åˆ†ä½™é¢æŸ¥è¯¢
4. âœ… ç§¯åˆ†å†å²è®°å½•

---

## ğŸ“‹ åç«¯API

### 1. æ¶ˆè´¹ç§¯åˆ† API

**æ¥å£**: `POST /api/credits/consume`

**åŠŸèƒ½**: ç”¨æˆ·æ¶ˆè´¹ç§¯åˆ†ï¼ˆç”¨äºç”Ÿæˆè§†é¢‘ã€ç”Ÿæˆè„šæœ¬ç­‰åŠŸèƒ½ï¼‰

**è¯·æ±‚å‚æ•°**:
```json
{
  "user_id": "ç”¨æˆ·ID",
  "amount": 50,
  "action": "ç”Ÿæˆè§†é¢‘",
  "description": "ç”Ÿæˆ1ä¸ª10ç§’è§†é¢‘"
}
```

**å“åº”**:
```json
{
  "success": true,
  "credits": 470,
  "consumed": 50,
  "message": "æ¶ˆè´¹ 50 ç§¯åˆ†æˆåŠŸï¼Œå‰©ä½™ 470 ç§¯åˆ†"
}
```

**ç‰¹æ€§**:
- âœ… æ£€æŸ¥ç§¯åˆ†ä½™é¢æ˜¯å¦è¶³å¤Ÿ
- âœ… æ‰£é™¤ç§¯åˆ†
- âœ… è®°å½•ç§¯åˆ†å†å²
- âœ… äº‹åŠ¡å¤„ç†ï¼ˆå¤±è´¥è‡ªåŠ¨å›æ»šï¼‰

**ä½¿ç”¨åœºæ™¯**:
- ç”Ÿæˆè§†é¢‘ï¼ˆ50ç§¯åˆ†/æ¬¡ï¼‰
- ç”Ÿæˆè„šæœ¬ï¼ˆ10ç§¯åˆ†/æ¬¡ï¼‰
- AIç”Ÿæˆè§’è‰²ï¼ˆ5ç§¯åˆ†/æ¬¡ï¼‰
- å…¶ä»–ä»˜è´¹åŠŸèƒ½

---

### 2. å……å€¼ç§¯åˆ† API

**æ¥å£**: `POST /api/credits/recharge`

**åŠŸèƒ½**: ç”¨æˆ·è´­ä¹°ç§¯åˆ†ï¼ˆé€šè¿‡å¾®ä¿¡ã€æ”¯ä»˜å®ç­‰æ”¯ä»˜ï¼‰

**è¯·æ±‚å‚æ•°**:
```json
{
  "user_id": "ç”¨æˆ·ID",
  "amount": 100,
  "credits": 1000,
  "payment_method": "å¾®ä¿¡æ”¯ä»˜",
  "order_id": "WX20251219123456"
}
```

**å“åº”**:
```json
{
  "success": true,
  "credits": 1520,
  "recharged": 1000,
  "amount": 100,
  "message": "å……å€¼æˆåŠŸï¼è·å¾— 1000 ç§¯åˆ†ï¼Œå½“å‰ä½™é¢ 1520 ç§¯åˆ†"
}
```

**ç‰¹æ€§**:
- âœ… å¢åŠ ç”¨æˆ·ç§¯åˆ†
- âœ… è®°å½•å……å€¼å†å²
- âœ… ä¿å­˜æ”¯ä»˜æ–¹å¼å’Œè®¢å•å·
- âœ… äº‹åŠ¡å¤„ç†

**å……å€¼å¥—é¤å»ºè®®**:
| é‡‘é¢ | ç§¯åˆ† | ä¼˜æƒ  |
|------|------|------|
| Â¥10 | 100 | - |
| Â¥50 | 550 | é€50ç§¯åˆ† |
| Â¥100 | 1200 | é€200ç§¯åˆ† |
| Â¥500 | 6500 | é€1500ç§¯åˆ† |

---

### 3. æŸ¥è¯¢ç§¯åˆ†ä½™é¢ API

**æ¥å£**: `GET /api/credits/balance/{user_id}`

**åŠŸèƒ½**: è·å–ç”¨æˆ·å½“å‰ç§¯åˆ†ä½™é¢

**å“åº”**:
```json
{
  "success": true,
  "user_id": "xxx",
  "credits": 520,
  "username": "æµ‹è¯•ç”¨æˆ·",
  "email": "test@example.com"
}
```

---

### 4. ç§¯åˆ†å†å²è®°å½• API

**æ¥å£**: `GET /api/credits/history/{user_id}`

**åŠŸèƒ½**: æŸ¥çœ‹ç”¨æˆ·çš„ç§¯åˆ†å˜åŠ¨å†å²

**å“åº”**:
```json
{
  "history": [
    {
      "id": "xxx",
      "action": "ç”Ÿæˆè§†é¢‘",
      "amount": -50,
      "balanceAfter": 470,
      "description": "ç”Ÿæˆè§†é¢‘ æ¶ˆè€— 50 ç§¯åˆ†",
      "createdAt": 1734573600000
    },
    {
      "id": "yyy",
      "action": "å……å€¼ï¼ˆå¾®ä¿¡æ”¯ä»˜ï¼‰",
      "amount": 1000,
      "balanceAfter": 520,
      "description": "æ”¯ä»˜ 100 å…ƒï¼Œè·å¾— 1000 ç§¯åˆ†",
      "createdAt": 1734570000000
    },
    {
      "id": "zzz",
      "action": "æ³¨å†Œå¥–åŠ±",
      "amount": 520,
      "balanceAfter": 520,
      "description": "æ–°ç”¨æˆ·æ³¨å†Œèµ é€520ç§¯åˆ†",
      "createdAt": 1734566400000
    }
  ]
}
```

**è¯´æ˜**:
- `amount` ä¸ºæ­£æ•°ï¼šå……å€¼æˆ–å¥–åŠ±
- `amount` ä¸ºè´Ÿæ•°ï¼šæ¶ˆè´¹æˆ–æ‰£é™¤
- `balanceAfter` ä¸ºæ“ä½œåçš„ç§¯åˆ†ä½™é¢
- æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨æœ€å‰é¢ï¼‰

---

## ğŸ“± å‰ç«¯APIè°ƒç”¨

### 1. æ¶ˆè´¹ç§¯åˆ†

```typescript
import { api } from '../lib/api';
import { useAuthStore } from '../lib/store';

// ç”Ÿæˆè§†é¢‘æ—¶æ‰£é™¤ç§¯åˆ†
const handleGenerateVideo = async () => {
  const { currentUser } = useAuthStore.getState();
  
  try {
    // å…ˆæ‰£é™¤ç§¯åˆ†
    const result = await api.consumeCredits({
      user_id: currentUser.id,
      amount: 50,
      action: 'ç”Ÿæˆè§†é¢‘',
      description: 'ç”Ÿæˆ10ç§’ç«–å±è§†é¢‘'
    });
    
    console.log(`ç§¯åˆ†æ‰£é™¤æˆåŠŸï¼Œå‰©ä½™: ${result.credits}`);
    
    // ç„¶åè°ƒç”¨è§†é¢‘ç”ŸæˆAPI
    // ...
    
  } catch (error) {
    alert(error.message); // "ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†ï¼š20ï¼Œéœ€è¦ï¼š50"
  }
};
```

---

### 2. å……å€¼ç§¯åˆ†

```typescript
// ç”¨æˆ·é€‰æ‹©å……å€¼å¥—é¤
const handleRecharge = async (packageType: string) => {
  const { currentUser } = useAuthStore.getState();
  
  // å……å€¼å¥—é¤é…ç½®
  const packages = {
    'small': { amount: 10, credits: 100 },
    'medium': { amount: 50, credits: 550 },
    'large': { amount: 100, credits: 1200 },
  };
  
  const pkg = packages[packageType];
  
  try {
    // 1. è°ƒç”¨æ”¯ä»˜æ¥å£ï¼ˆè¿™é‡Œéœ€è¦é›†æˆå¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ï¼‰
    // const paymentResult = await callPaymentAPI(pkg.amount);
    
    // 2. æ”¯ä»˜æˆåŠŸåï¼Œè°ƒç”¨å……å€¼æ¥å£
    const result = await api.rechargeCredits({
      user_id: currentUser.id,
      amount: pkg.amount,
      credits: pkg.credits,
      payment_method: 'å¾®ä¿¡æ”¯ä»˜',
      order_id: 'WX20251219123456' // æ”¯ä»˜å¹³å°è¿”å›çš„è®¢å•å·
    });
    
    // 3. æ›´æ–°æœ¬åœ°storeä¸­çš„ç§¯åˆ†
    useAuthStore.getState().updateUser({ 
      credits: result.credits 
    });
    
    alert(result.message);
    
  } catch (error) {
    alert('å……å€¼å¤±è´¥ï¼š' + error.message);
  }
};
```

---

### 3. æŸ¥è¯¢ç§¯åˆ†ä½™é¢

```typescript
// å®šæœŸæ›´æ–°ç§¯åˆ†ä½™é¢
const updateCreditsBalance = async () => {
  const { currentUser } = useAuthStore.getState();
  
  try {
    const result = await api.getCreditsBalance(currentUser.id);
    
    // æ›´æ–°store
    useAuthStore.getState().updateUser({ 
      credits: result.credits 
    });
    
  } catch (error) {
    console.error('è·å–ç§¯åˆ†å¤±è´¥:', error);
  }
};

// é¡µé¢åŠ è½½æ—¶è·å–
useEffect(() => {
  updateCreditsBalance();
}, []);
```

---

### 4. æŸ¥çœ‹ç§¯åˆ†å†å²

```typescript
// ç§¯åˆ†å†å²é¡µé¢
const CreditsHistory = () => {
  const [history, setHistory] = useState([]);
  const { currentUser } = useAuthStore();
  
  useEffect(() => {
    const loadHistory = async () => {
      try {
        const result = await api.getCreditsHistory(currentUser.id);
        setHistory(result.history);
      } catch (error) {
        console.error('è·å–å†å²å¤±è´¥:', error);
      }
    };
    
    loadHistory();
  }, [currentUser.id]);
  
  return (
    <div>
      <h2>ç§¯åˆ†å†å²</h2>
      {history.map(item => (
        <div key={item.id}>
          <span>{item.action}</span>
          <span className={item.amount > 0 ? 'green' : 'red'}>
            {item.amount > 0 ? '+' : ''}{item.amount}
          </span>
          <span>ä½™é¢: {item.balanceAfter}</span>
          <span>{new Date(item.createdAt).toLocaleString()}</span>
        </div>
      ))}
    </div>
  );
};
```

---

## ğŸ’¡ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šç”Ÿæˆè§†é¢‘æ—¶è‡ªåŠ¨æ‰£é™¤ç§¯åˆ†

```typescript
// åœ¨ /generate-video API ä¸­é›†æˆç§¯åˆ†æ‰£é™¤
@app.post("/generate-video")
async def generate_video(req: GenerateVideoRequest, db: Session = Depends(get_db)):
    # 1. æ£€æŸ¥å¹¶æ‰£é™¤ç§¯åˆ†
    if req.user_id:
        user = db.query(User).filter(User.id == req.user_id).first()
        if not user or user.credits < 50:
            raise HTTPException(status_code=400, detail="ç§¯åˆ†ä¸è¶³")
        
        # æ‰£é™¤ç§¯åˆ†
        user.credits -= 50
        credit_history = CreditHistory(
            id=str(uuid.uuid4()),
            user_id=req.user_id,
            action="ç”Ÿæˆè§†é¢‘",
            amount=-50,
            balance_after=user.credits,
            description=f"ç”Ÿæˆ{req.duration}ç§’{req.orientation}è§†é¢‘"
        )
        db.add(credit_history)
    
    # 2. ç”Ÿæˆè§†é¢‘
    result = await generate_video_with_ai(...)
    
    # 3. æäº¤äº‹åŠ¡
    db.commit()
    
    return result
```

---

### åœºæ™¯2ï¼šå……å€¼å®Œæˆåçš„å›è°ƒå¤„ç†

```typescript
// å¾®ä¿¡æ”¯ä»˜å›è°ƒï¼ˆéœ€è¦åœ¨æœåŠ¡å™¨ç«¯å®ç°ï¼‰
@app.post("/api/payment/callback/wechat")
async def wechat_payment_callback(data: dict, db: Session = Depends(get_db)):
    # 1. éªŒè¯ç­¾å
    if not verify_wechat_signature(data):
        raise HTTPException(status_code=400, detail="ç­¾åéªŒè¯å¤±è´¥")
    
    # 2. æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
    if data['result_code'] == 'SUCCESS':
        order_id = data['out_trade_no']
        
        # 3. å……å€¼ç§¯åˆ†
        # ï¼ˆå·²åœ¨å‰ç«¯è°ƒç”¨å……å€¼APIæ—¶å®Œæˆï¼‰
        
        return {"return_code": "SUCCESS"}
    
    return {"return_code": "FAIL"}
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### users è¡¨ï¼ˆç”¨æˆ·ç§¯åˆ†å­—æ®µï¼‰
```sql
credits INTEGER DEFAULT 0  -- ç”¨æˆ·ç§¯åˆ†ä½™é¢
```

### credit_history è¡¨ï¼ˆç§¯åˆ†å†å²è®°å½•ï¼‰
```sql
id VARCHAR PRIMARY KEY
user_id VARCHAR REFERENCES users(id)
action VARCHAR  -- æ“ä½œç±»å‹ï¼šå……å€¼ã€æ¶ˆè´¹ã€å¥–åŠ±ç­‰
amount INTEGER  -- å˜åŠ¨é‡‘é¢ï¼ˆæ­£æ•°ä¸ºå¢åŠ ï¼Œè´Ÿæ•°ä¸ºå‡å°‘ï¼‰
balance_after INTEGER  -- æ“ä½œåä½™é¢
description TEXT  -- è¯¦ç»†è¯´æ˜
created_at TIMESTAMP DEFAULT NOW()
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ç§¯åˆ†æ‰£é™¤é˜²é‡å¤
```python
# ä½¿ç”¨äº‹åŠ¡é”é˜²æ­¢å¹¶å‘æ‰£é™¤
from sqlalchemy import select
user = db.query(User).filter(User.id == user_id).with_for_update().first()
```

### 2. å……å€¼éªŒè¯
- âœ… éªŒè¯æ”¯ä»˜å›è°ƒç­¾å
- âœ… æ£€æŸ¥è®¢å•å·æ˜¯å¦å·²å¤„ç†
- âœ… è®°å½•æ”¯ä»˜æµæ°´
- âœ… å¼‚å¸¸æƒ…å†µå›æ»š

### 3. ç§¯åˆ†å†å²ä¸å¯åˆ é™¤
```python
# åªå…è®¸æŸ¥è¯¢ï¼Œä¸å…è®¸åˆ é™¤
@app.delete("/api/credits/history/{history_id}")
async def delete_history():
    raise HTTPException(status_code=403, detail="ç§¯åˆ†å†å²ä¸å¯åˆ é™¤")
```

---

## ğŸ¯ åç»­ä¼˜åŒ–

### 1. ç§¯åˆ†å¥—é¤é…ç½®
åˆ›å»ºç§¯åˆ†å¥—é¤è¡¨ï¼š
```python
class CreditPackage(Base):
    __tablename__ = "credit_packages"
    
    id = Column(String, primary_key=True)
    name = Column(String)  # å¥—é¤åç§°
    amount = Column(Integer)  # ä»·æ ¼ï¼ˆåˆ†ï¼‰
    credits = Column(Integer)  # ç§¯åˆ†æ•°é‡
    bonus = Column(Integer)  # èµ é€ç§¯åˆ†
    is_active = Column(Boolean, default=True)
```

### 2. ç§¯åˆ†è¿‡æœŸæœºåˆ¶
```python
class CreditHistory(Base):
    # ... ç°æœ‰å­—æ®µ
    expire_at = Column(DateTime)  # è¿‡æœŸæ—¶é—´
    is_expired = Column(Boolean, default=False)
```

### 3. ä¼šå‘˜ç­‰çº§ç§¯åˆ†åŠ æˆ
```python
# æ ¹æ®ç”¨æˆ·ç­‰çº§å¢åŠ ç§¯åˆ†è·å¾—
if user.vip_level == 'gold':
    credits = credits * 1.2  # é‡‘å¡ç”¨æˆ·å……å€¼é¢å¤–20%
```

### 4. ç§¯åˆ†æ¶ˆè´¹è®°å½•åˆ†ç±»ç»Ÿè®¡
```python
@app.get("/api/credits/stats/{user_id}")
async def get_credits_stats(user_id: str):
    # ç»Ÿè®¡å„ç±»æ¶ˆè´¹
    video_cost = sum(æ¶ˆè´¹è§†é¢‘çš„ç§¯åˆ†)
    script_cost = sum(æ¶ˆè´¹è„šæœ¬çš„ç§¯åˆ†)
    ...
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [x] åç«¯ç§¯åˆ†æ¶ˆè´¹API
- [x] åç«¯ç§¯åˆ†å……å€¼API
- [x] åç«¯ç§¯åˆ†ä½™é¢æŸ¥è¯¢API
- [x] åç«¯ç§¯åˆ†å†å²API
- [x] å‰ç«¯APIè°ƒç”¨æ–¹æ³•
- [ ] é›†æˆæ”¯ä»˜ç³»ç»Ÿï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰
- [ ] ç”Ÿæˆè§†é¢‘æ—¶è‡ªåŠ¨æ‰£é™¤ç§¯åˆ†
- [ ] ç”Ÿæˆè„šæœ¬æ—¶è‡ªåŠ¨æ‰£é™¤ç§¯åˆ†
- [ ] å‰ç«¯æ˜¾ç¤ºç§¯åˆ†ä½™é¢
- [ ] å‰ç«¯ç§¯åˆ†å†å²é¡µé¢
- [ ] å‰ç«¯å……å€¼é¡µé¢

---

## ğŸš€ æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1ï¼šæ¶ˆè´¹ç§¯åˆ†

```bash
curl -X POST http://115.190.137.87:8000/api/credits/consume \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "your-user-id",
    "amount": 50,
    "action": "ç”Ÿæˆè§†é¢‘",
    "description": "ç”Ÿæˆ10ç§’ç«–å±è§†é¢‘"
  }'
```

**é¢„æœŸç»“æœ**:
- âœ… ç§¯åˆ†å‡å°‘50
- âœ… è¿”å›å‰©ä½™ç§¯åˆ†
- âœ… è®°å½•åˆ°ç§¯åˆ†å†å²

---

### æµ‹è¯•2ï¼šå……å€¼ç§¯åˆ†

```bash
curl -X POST http://115.190.137.87:8000/api/credits/recharge \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "your-user-id",
    "amount": 100,
    "credits": 1000,
    "payment_method": "å¾®ä¿¡æ”¯ä»˜",
    "order_id": "TEST20251219001"
  }'
```

**é¢„æœŸç»“æœ**:
- âœ… ç§¯åˆ†å¢åŠ 1000
- âœ… è¿”å›æ–°çš„ç§¯åˆ†ä½™é¢
- âœ… è®°å½•å……å€¼å†å²

---

### æµ‹è¯•3ï¼šç§¯åˆ†ä¸è¶³

```bash
# å½“ç”¨æˆ·ç§¯åˆ†ä¸è¶³æ—¶
curl -X POST http://115.190.137.87:8000/api/credits/consume \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "your-user-id",
    "amount": 999999,
    "action": "æµ‹è¯•",
    "description": "æµ‹è¯•ç§¯åˆ†ä¸è¶³"
  }'
```

**é¢„æœŸç»“æœ**:
- âŒ HTTP 400
- âŒ é”™è¯¯ä¿¡æ¯ï¼š"ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†ï¼š520ï¼Œéœ€è¦ï¼š999999"
- âœ… æ•°æ®åº“ç§¯åˆ†æœªå˜åŒ–

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **äº‹åŠ¡å¤„ç†**: https://docs.sqlalchemy.org/en/20/orm/session_transaction.html
- **æ”¯ä»˜å®å¼€æ”¾å¹³å°**: https://open.alipay.com/
- **å¾®ä¿¡æ”¯ä»˜æ–‡æ¡£**: https://pay.weixin.qq.com/wiki/doc/api/index.html
