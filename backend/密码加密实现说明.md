# 密码加密实现说明

## ✅ 已完成

密码加密功能已成功实现，使用 **bcrypt** 加密算法保护用户密码。

---

## 📋 修改内容

### 1. 添加 bcrypt 依赖

**文件**: `backend/main.py` 第8行

```python
import bcrypt  # 新增：密码加密
```

---

### 2. 添加密码加密工具函数

**文件**: `backend/main.py` 第444-461行

```python
# ======================
# 密码加密工具函数
# ======================

def hash_password(password: str) -> str:
    """
    使用 bcrypt 加密密码
    """
    salt = bcrypt.gensalt()
    hashed = bcrypt.hashpw(password.encode('utf-8'), salt)
    return hashed.decode('utf-8')

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """
    验证密码是否正确
    """
    try:
        return bcrypt.checkpw(plain_password.encode('utf-8'), hashed_password.encode('utf-8'))
    except Exception as e:
        print(f"[密码验证错误] {str(e)}")
        return False
```

**功能说明**：
- `hash_password()` - 将明文密码加密为 bcrypt 哈希值
- `verify_password()` - 验证明文密码与哈希值是否匹配

---

### 3. 更新用户注册 API

**文件**: `backend/main.py` `/api/register` 接口

**修改前**：
```python
password=req.password,  # TODO: 应该使用 bcrypt 等加密
```

**修改后**：
```python
# 加密密码
hashed_password = hash_password(req.password)

# 创建新用户
new_user = User(
    id=user_id,
    email=req.email,
    username=req.username,
    password=hashed_password,  # 使用加密后的密码
    credits=520,
    role="user",
    is_active=True
)
```

---

### 4. 更新用户登录 API

**文件**: `backend/main.py` `/api/login` 接口

**修改前**：
```python
# 验证密码（注意：实际应用中应该使用加密后的密码比对）
if user.password != req.password:
    raise HTTPException(status_code=401, detail="邮箱或密码错误")
```

**修改后**：
```python
# 验证密码（使用 bcrypt 验证）
if not verify_password(req.password, user.password):
    raise HTTPException(status_code=401, detail="邮箱或密码错误")
```

---

## 🔒 安全特性

### 1. **单向加密**
- 密码使用 bcrypt 哈希算法加密
- **不可逆**：无法从哈希值还原出原始密码
- 即使数据库泄露，攻击者也无法获得明文密码

### 2. **自动加盐（Salt）**
- bcrypt 会为每个密码自动生成随机盐值
- 即使两个用户密码相同，存储的哈希值也不同
- 防止彩虹表攻击

### 3. **慢速哈希**
- bcrypt 故意设计为计算缓慢
- 增加暴力破解的时间成本
- 默认工作因子（cost factor）为 12

---

## 📊 数据库存储格式

### 加密前（明文 - ❌ 不安全）
```
password: "123456"
```

### 加密后（bcrypt - ✅ 安全）
```
password: "$2b$12$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy"
```

**格式说明**：
- `$2b$` - bcrypt 算法版本
- `12` - 工作因子（cost factor）
- `N9qo8uLOickgx2ZMRZoMye` - 22个字符的盐值
- `IjZAgcfl7p92ldGxad68LJZdL17lhWy` - 31个字符的哈希值

---

## 🧪 测试验证

### 1. 注册新用户

**请求**：
```bash
curl -X POST http://115.190.137.87:8000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "mypassword123",
    "username": "测试用户"
  }'
```

**预期结果**：
- ✅ 用户创建成功
- ✅ 密码以 bcrypt 哈希格式存储到数据库
- ✅ 返回用户信息（不包含密码）

### 2. 登录验证

**请求**：
```bash
curl -X POST http://115.190.137.87:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "mypassword123"
  }'
```

**预期结果**：
- ✅ 正确密码：登录成功
- ❌ 错误密码：返回 401 错误

---

## 📦 依赖安装

### 检查是否已安装 bcrypt

```bash
pip list | grep bcrypt
```

### 如果未安装，需要安装

```bash
pip install bcrypt
```

**或**在 `requirements.txt` 中添加：
```
bcrypt==4.1.2
```

然后运行：
```bash
pip install -r requirements.txt
```

---

## ⚠️ 重要提醒

### 1. 旧用户数据迁移

如果数据库中已经有使用明文密码的用户，需要：

**方案A**：要求用户重置密码
- 发送密码重置邮件
- 用户重新设置密码时使用加密

**方案B**：数据库迁移脚本
```python
# 迁移脚本示例
from database import get_db, User
from main import hash_password

db = next(get_db())
users = db.query(User).all()

for user in users:
    # 检查是否已经是 bcrypt 格式
    if not user.password.startswith('$2b$'):
        # 明文密码，需要加密
        user.password = hash_password(user.password)
        print(f"已加密用户 {user.email} 的密码")

db.commit()
print("密码迁移完成！")
```

### 2. 测试管理员账户

如果有测试账户（如 `admin@soradirector.com`），需要重新注册或手动更新密码为加密格式。

---

## ✅ 完成检查清单

- [x] 安装 bcrypt 依赖
- [x] 添加密码加密函数 `hash_password()`
- [x] 添加密码验证函数 `verify_password()`
- [x] 更新注册 API 使用加密
- [x] 更新登录 API 使用验证
- [ ] 安装 bcrypt 到服务器（如果未安装）
- [ ] 迁移旧用户密码（如果有）
- [ ] 测试新用户注册
- [ ] 测试用户登录

---

## 🚀 下一步

### 立即部署

1. **安装 bcrypt**（如果未安装）：
   ```bash
   ssh root@115.190.137.87
   cd /root/AIvdeo/backend
   pip install bcrypt
   ```

2. **重启后端服务**：
   ```bash
   pkill -9 -f "uvicorn main:app"
   nohup uvicorn main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
   ```

3. **测试注册登录**：
   - 注册新用户
   - 检查数据库中密码是否加密
   - 测试登录功能

### 后续优化

1. ⭐ 添加密码强度验证（最少8位、包含数字和字母等）
2. ⭐ 添加密码重置功能
3. ⭐ 添加登录失败次数限制（防暴力破解）
4. ⭐ 添加JWT Token认证（替代每次传密码）
5. ⭐ 记录登录日志（IP地址、时间等）

---

## 📚 参考资料

- **bcrypt 官方文档**: https://pypi.org/project/bcrypt/
- **密码哈希最佳实践**: https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html
- **bcrypt 在线测试**: https://bcrypt-generator.com/
