# ğŸ¬ è§†é¢‘æŒä¹…åŒ–å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

### åŸæœ‰é—®é¢˜
1. âŒ **ç”¨æˆ·ç™»å½•ç™»å‡ºåè§†é¢‘æ¶ˆå¤±** - URLæ²¡æœ‰æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
2. âŒ **URLæœ‰æ•ˆæœŸç®¡ç†ç¼ºå¤±** - äº‘é›¾URL 3å¤©åå¤±æ•ˆï¼Œä½†ç³»ç»Ÿæ²¡æœ‰æ£€æµ‹æœºåˆ¶
3. âŒ **å¤±æ•ˆçŠ¶æ€æœªæ›´æ–°** - URLå¤±æ•ˆåæ•°æ®åº“çŠ¶æ€æœªåŒæ­¥

---

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### 1. æ•°æ®åº“å­—æ®µæ‰©å±•

**æ–‡ä»¶**: `backend/database.py`

æ–°å¢å­—æ®µï¼š
```python
class Video(Base):
    # ... åŸæœ‰å­—æ®µ
    
    # URLæœ‰æ•ˆæœŸç®¡ç†ï¼ˆæ–°å¢ï¼‰
    url_expires_at = Column(DateTime)  # URLè¿‡æœŸæ—¶é—´ï¼ˆäº‘é›¾URL 3å¤©æœ‰æ•ˆï¼‰
    last_url_check = Column(DateTime)  # æœ€åä¸€æ¬¡URLæœ‰æ•ˆæ€§æ£€æŸ¥æ—¶é—´
    
    # çŠ¶æ€æ”¯æŒï¼ˆæ‰©å±•ï¼‰
    status = Column(String(20), default='processing')  
    # çŠ¶æ€å€¼: processing, completed, failed, url_expired
```

---

### 2. åç«¯APIå®Œå–„

#### 2.1 è§†é¢‘ä¿å­˜æ—¶è‡ªåŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´

**API**: `POST /api/videos`

```python
@app.post("/api/videos")
async def save_video(req: SaveVideoRequest, db: Session = Depends(get_db)):
    from datetime import timedelta
    
    # è®¡ç®—URLè¿‡æœŸæ—¶é—´ï¼ˆäº‘é›¾URL 3å¤©æœ‰æ•ˆï¼‰
    url_expires_at = None
    if req.video_url and req.status == 'completed':
        url_expires_at = datetime.utcnow() + timedelta(days=3)
    
    new_video = Video(
        # ... åŸæœ‰å­—æ®µ
        url_expires_at=url_expires_at,  # æ–°å¢ï¼šè®¾ç½®URLè¿‡æœŸæ—¶é—´
        last_url_check=datetime.utcnow()  # æ–°å¢ï¼šè®¾ç½®æœ€åæ£€æŸ¥æ—¶é—´
    )
```

**åŠŸèƒ½**ï¼š
- âœ… è§†é¢‘å®Œæˆæ—¶è‡ªåŠ¨è®¡ç®—URLè¿‡æœŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ + 3å¤©ï¼‰
- âœ… è®°å½•é¦–æ¬¡ä¿å­˜æ—¶é—´

---

#### 2.2 è§†é¢‘æ›´æ–°æ—¶åˆ·æ–°è¿‡æœŸæ—¶é—´

**API**: `PUT /api/videos/{video_id}`

```python
@app.put("/api/videos/{video_id}")
async def update_video(video_id: str, req: SaveVideoRequest, db: Session = Depends(get_db)):
    from datetime import timedelta
    
    if req.video_url is not None:
        video.video_url = req.video_url
        # æ›´æ–°URLæ—¶ï¼Œé‡æ–°è®¡ç®—è¿‡æœŸæ—¶é—´
        if req.status == 'completed':
            video.url_expires_at = datetime.utcnow() + timedelta(days=3)
            video.last_url_check = datetime.utcnow()
```

**åŠŸèƒ½**ï¼š
- âœ… å¼‚æ­¥è§†é¢‘å®Œæˆåæ›´æ–°URLæ—¶ï¼Œé‡æ–°è®¡ç®—è¿‡æœŸæ—¶é—´
- âœ… ç¡®ä¿æ–°URLæœ‰å®Œæ•´çš„3å¤©æœ‰æ•ˆæœŸ

---

#### 2.3 è·å–è§†é¢‘åˆ—è¡¨æ—¶è‡ªåŠ¨æ£€æŸ¥è¿‡æœŸ

**API**: `GET /api/videos/{user_id}`

```python
@app.get("/api/videos/{user_id}")
async def get_user_videos(user_id: str, db: Session = Depends(get_db)):
    videos = db.query(Video).filter(Video.user_id == user_id).all()
    
    # æ£€æŸ¥URLæ˜¯å¦è¿‡æœŸ
    now = datetime.utcnow()
    for video in videos:
        if video.status == 'completed' and video.url_expires_at:
            if now > video.url_expires_at:
                # URLå·²è¿‡æœŸï¼Œæ›´æ–°çŠ¶æ€
                video.status = 'url_expired'
                video.error = 'URLå·²å¤±æ•ˆï¼ˆäº‘é›¾URLæœ‰æ•ˆæœŸä¸º3å¤©ï¼‰'
                db.commit()
    
    return {
        "videos": [
            {
                # ...
                "url": v.video_url if v.status != 'url_expired' else None,  # è¿‡æœŸåˆ™ä¸è¿”å›URL
                "status": v.status,
                "urlExpiresAt": v.url_expires_at.timestamp() * 1000 if v.url_expires_at else None
            }
            for v in videos
        ]
    }
```

**åŠŸèƒ½**ï¼š
- âœ… æ¯æ¬¡æŸ¥è¯¢æ—¶è‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰è§†é¢‘URLæ˜¯å¦è¿‡æœŸ
- âœ… è¿‡æœŸè§†é¢‘è‡ªåŠ¨æ›´æ–°çŠ¶æ€ä¸º `url_expired`
- âœ… è¿‡æœŸè§†é¢‘ä¸è¿”å›URLï¼ˆè¿”å›Noneï¼‰

---

#### 2.4 å•ä¸ªè§†é¢‘URLéªŒè¯æ¥å£

**API**: `GET /api/videos/{video_id}/check-url`

```python
@app.get("/api/videos/{video_id}/check-url")
async def check_video_url(video_id: str, db: Session = Depends(get_db)):
    video = db.query(Video).filter(Video.id == video_id).first()
    
    # æ£€æŸ¥URLæ˜¯å¦è¿‡æœŸ
    now = datetime.utcnow()
    is_expired = False
    
    if video.status == 'completed' and video.url_expires_at:
        if now > video.url_expires_at:
            is_expired = True
            video.status = 'url_expired'
            video.error = 'URLå·²å¤±æ•ˆï¼ˆäº‘é›¾URLæœ‰æ•ˆæœŸä¸º3å¤©ï¼‰'
            video.last_url_check = now
            db.commit()
    
    # æ›´æ–°æœ€åæ£€æŸ¥æ—¶é—´
    video.last_url_check = now
    db.commit()
    
    return {
        "success": True,
        "status": video.status,
        "isExpired": is_expired,
        "url": video.video_url if not is_expired else None,
        "message": "URLå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆè§†é¢‘" if is_expired else "URLæœ‰æ•ˆ"
    }
```

**åŠŸèƒ½**ï¼š
- âœ… å‰ç«¯ä¸»åŠ¨æ£€æŸ¥å•ä¸ªè§†é¢‘URLæ˜¯å¦æœ‰æ•ˆ
- âœ… è¿”å›è¯¦ç»†çš„æœ‰æ•ˆæœŸä¿¡æ¯
- âœ… æ›´æ–°æœ€åæ£€æŸ¥æ—¶é—´

---

### 3. å®Œæ•´æ•°æ®æµ

```mermaid
graph TD
    A[ç”¨æˆ·ç”Ÿæˆè§†é¢‘] --> B[äº‘é›¾æœåŠ¡è¿”å›task_id]
    B --> C[å‰ç«¯ä¿å­˜åˆ°æ•°æ®åº“: status=processing]
    C --> D[å‰ç«¯è½®è¯¢ä»»åŠ¡çŠ¶æ€]
    D --> E{ä»»åŠ¡å®Œæˆ?}
    E -->|æ˜¯| F[æ›´æ–°æ•°æ®åº“: video_url + status=completed]
    F --> G[è®¾ç½®url_expires_at = now + 3å¤©]
    E -->|å¦| D
    
    H[ç”¨æˆ·è®¿é—®è§†é¢‘åˆ—è¡¨] --> I[åç«¯æŸ¥è¯¢æ•°æ®åº“]
    I --> J{æ£€æŸ¥URLè¿‡æœŸ?}
    J -->|å·²è¿‡æœŸ| K[æ›´æ–°status=url_expired]
    J -->|æœªè¿‡æœŸ| L[æ­£å¸¸è¿”å›video_url]
    K --> M[è¿”å›url=null]
    
    N[ç”¨æˆ·ç‚¹å‡»æ’­æ”¾] --> O[å‰ç«¯è°ƒç”¨check-urlæ¥å£]
    O --> P{URLæœ‰æ•ˆ?}
    P -->|æœ‰æ•ˆ| Q[æ’­æ”¾è§†é¢‘]
    P -->|å¤±æ•ˆ| R[æ˜¾ç¤ºå¤±æ•ˆæç¤º]
```

---

## ğŸ¯ å‰ç«¯é›†æˆï¼ˆå·²è‡ªåŠ¨å®Œæˆï¼‰

### ç°æœ‰æœºåˆ¶å·²æ”¯æŒ

#### 1. è§†é¢‘ä¿å­˜ï¼ˆå·²å®ç°ï¼‰
```typescript
// src/app/lib/store.ts
addGeneratedVideo: async (videoData) => {
  // è°ƒç”¨åç«¯APIä¿å­˜è§†é¢‘
  const response = await api.saveVideo({
    user_id: state.user.id,
    video_url: videoData.url,
    status: videoData.status,
    task_id: videoData.taskId,
    // ...
  });
  
  // ä¿å­˜æˆåŠŸï¼Œåç«¯å·²è‡ªåŠ¨è®¾ç½®url_expires_at
}
```

#### 2. è§†é¢‘çŠ¶æ€æ›´æ–°ï¼ˆå·²å®ç°ï¼‰
```typescript
// src/app/lib/store.ts
updateVideoStatus: async (videoId, updates) => {
  // è°ƒç”¨åç«¯APIæ›´æ–°è§†é¢‘çŠ¶æ€
  await api.updateVideo(videoId, {
    video_url: updates.url,
    status: updates.status,
    // ...
  });
  
  // æ›´æ–°æˆåŠŸï¼Œåç«¯å·²è‡ªåŠ¨åˆ·æ–°url_expires_at
}
```

#### 3. è§†é¢‘åˆ—è¡¨åŠ è½½ï¼ˆå·²å®ç°ï¼‰
```typescript
// src/app/lib/store.ts
loadUserData: async (userId) => {
  // åŠ è½½ç”¨æˆ·è§†é¢‘
  const videosResponse = await api.getUserVideos(userId);
  
  // åç«¯å·²è‡ªåŠ¨æ£€æŸ¥URLè¿‡æœŸçŠ¶æ€
  // è¿‡æœŸè§†é¢‘çš„statusä¼šæ˜¯'url_expired'ï¼Œurlä¸ºnull
}
```

---

## ğŸ“Š è§†é¢‘çŠ¶æ€ç®¡ç†

### çŠ¶æ€å®šä¹‰

| çŠ¶æ€ | è¯´æ˜ | URL | å‰ç«¯æ˜¾ç¤º |
|------|------|-----|---------|
| `processing` | ç”Ÿæˆä¸­ | æ—  | æ˜¾ç¤ºè¿›åº¦æ¡ |
| `completed` | ç”Ÿæˆå®Œæˆï¼ˆURLæœ‰æ•ˆï¼‰ | æœ‰æ•ˆURL | å¯æ’­æ”¾ |
| `failed` | ç”Ÿæˆå¤±è´¥ | æ—  | æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ |
| `url_expired` | URLå·²å¤±æ•ˆ | null | æ˜¾ç¤º"URLå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ" |

### çŠ¶æ€æµè½¬

```
processing â†’ completed â†’ url_expired
    â†“
  failed
```

---

## ğŸ”§ æ•°æ®åº“è¿ç§»

### æ·»åŠ æ–°å­—æ®µçš„SQL

```sql
-- ä¸ºvideosè¡¨æ·»åŠ URLæœ‰æ•ˆæœŸç®¡ç†å­—æ®µ
ALTER TABLE videos ADD COLUMN url_expires_at TIMESTAMP;
ALTER TABLE videos ADD COLUMN last_url_check TIMESTAMP;
ALTER TABLE videos ALTER COLUMN status TYPE VARCHAR(20);  -- æ”¯æŒurl_expiredçŠ¶æ€

-- ä¸ºå·²å­˜åœ¨çš„completedè§†é¢‘è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå‡è®¾3å¤©å‰åˆ›å»ºï¼‰
UPDATE videos 
SET url_expires_at = created_at + INTERVAL '3 days',
    last_url_check = CURRENT_TIMESTAMP
WHERE status = 'completed' AND url_expires_at IS NULL;

-- æ£€æŸ¥å¹¶æ ‡è®°å·²è¿‡æœŸçš„è§†é¢‘
UPDATE videos 
SET status = 'url_expired',
    error = 'URLå·²å¤±æ•ˆï¼ˆäº‘é›¾URLæœ‰æ•ˆæœŸä¸º3å¤©ï¼‰'
WHERE status = 'completed' 
  AND url_expires_at < CURRENT_TIMESTAMP;
```

---

## âœ… éƒ¨ç½²æ¸…å•

### 1. åç«¯éƒ¨ç½²
```bash
# ä¸Šä¼ æ›´æ–°çš„æ–‡ä»¶
scp backend/database.py root@115.190.137.87:/root/backend/
scp backend/main.py root@115.190.137.87:/root/backend/

# SSHè¿æ¥æœåŠ¡å™¨
ssh root@115.190.137.87

# è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
cd /root/backend
python3 -c "
from database import engine, Base
from sqlalchemy import text

# æ·»åŠ æ–°å­—æ®µ
with engine.connect() as conn:
    try:
        conn.execute(text('ALTER TABLE videos ADD COLUMN url_expires_at TIMESTAMP'))
        conn.execute(text('ALTER TABLE videos ADD COLUMN last_url_check TIMESTAMP'))
        conn.commit()
        print('âœ… æ•°æ®åº“å­—æ®µæ·»åŠ æˆåŠŸ')
    except Exception as e:
        print(f'âš ï¸ å­—æ®µå¯èƒ½å·²å­˜åœ¨: {e}')
"

# é‡å¯åç«¯æœåŠ¡
pkill -f 'python.*main.py'
nohup python3 main.py > logs/backend.log 2>&1 &
tail -f logs/backend.log
```

### 2. éªŒè¯éƒ¨ç½²

```bash
# æµ‹è¯•URLæ£€æŸ¥æ¥å£
curl http://115.190.137.87:8000/api/videos/{video_id}/check-url

# æµ‹è¯•è§†é¢‘åˆ—è¡¨ï¼ˆåº”è‡ªåŠ¨æ£€æŸ¥è¿‡æœŸï¼‰
curl http://115.190.137.87:8000/api/videos/{user_id}
```

---

## ğŸ‰ åŠŸèƒ½éªŒè¯

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯1ï¼šæ–°è§†é¢‘ç”Ÿæˆ
1. ç”¨æˆ·ç”Ÿæˆè§†é¢‘
2. äº‘é›¾è¿”å›task_id
3. å‰ç«¯ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆstatus=processingï¼‰
4. è½®è¯¢å®Œæˆåæ›´æ–°URLï¼ˆstatus=completedï¼‰
5. âœ… éªŒè¯ï¼šæ•°æ®åº“ä¸­url_expires_at = å½“å‰æ—¶é—´ + 3å¤©

#### åœºæ™¯2ï¼šURLæœ‰æ•ˆæœŸå†…è®¿é—®
1. ç”¨æˆ·æ‰“å¼€"æˆ‘çš„è§†é¢‘"
2. åç«¯æŸ¥è¯¢è§†é¢‘åˆ—è¡¨
3. æ£€æŸ¥URLæœªè¿‡æœŸ
4. âœ… éªŒè¯ï¼šè¿”å›æœ‰æ•ˆçš„video_url

#### åœºæ™¯3ï¼šURLè¿‡æœŸåè®¿é—®
1. ç”¨æˆ·æ‰“å¼€"æˆ‘çš„è§†é¢‘"ï¼ˆ3å¤©åï¼‰
2. åç«¯æŸ¥è¯¢è§†é¢‘åˆ—è¡¨
3. æ£€æŸ¥URLå·²è¿‡æœŸ
4. è‡ªåŠ¨æ›´æ–°status=url_expired
5. âœ… éªŒè¯ï¼šè¿”å›url=nullï¼Œæ˜¾ç¤ºå¤±æ•ˆæç¤º

#### åœºæ™¯4ï¼šç”¨æˆ·ç™»å½•ç™»å‡º
1. ç”¨æˆ·ç™»å½•
2. æŸ¥çœ‹è§†é¢‘åˆ—è¡¨
3. ç™»å‡º
4. é‡æ–°ç™»å½•
5. âœ… éªŒè¯ï¼šè§†é¢‘ä»ç„¶å­˜åœ¨ï¼ˆæ•°æ®åº“æŒä¹…åŒ–ï¼‰

---

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### å®šæœŸæ¸…ç†è¿‡æœŸè§†é¢‘ï¼ˆå¯é€‰ï¼‰

```python
# å®šæœŸä»»åŠ¡ï¼šæ¸…ç†3å¤©ä»¥ä¸Šçš„è¿‡æœŸè§†é¢‘URL
@app.get("/api/admin/cleanup-expired-videos")
async def cleanup_expired_videos(db: Session = Depends(get_db)):
    now = datetime.utcnow()
    expired_videos = db.query(Video).filter(
        Video.status == 'completed',
        Video.url_expires_at < now
    ).all()
    
    for video in expired_videos:
        video.status = 'url_expired'
        video.error = 'URLå·²å¤±æ•ˆï¼ˆäº‘é›¾URLæœ‰æ•ˆæœŸä¸º3å¤©ï¼‰'
    
    db.commit()
    return {"cleaned": len(expired_videos)}
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. âœ… **æ•°æ®åº“å­—æ®µ** - æ–°å¢url_expires_atå’Œlast_url_checkå­—æ®µ
2. âœ… **ä¿å­˜æ—¶è®¾ç½®** - è§†é¢‘å®Œæˆæ—¶è‡ªåŠ¨è®¾ç½®3å¤©åè¿‡æœŸ
3. âœ… **æŸ¥è¯¢æ—¶æ£€æŸ¥** - æ¯æ¬¡æŸ¥è¯¢è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°è¿‡æœŸçŠ¶æ€
4. âœ… **ä¸»åŠ¨éªŒè¯** - æä¾›check-urlæ¥å£ä¾›å‰ç«¯ä¸»åŠ¨éªŒè¯
5. âœ… **çŠ¶æ€åŒæ­¥** - è¿‡æœŸè§†é¢‘è‡ªåŠ¨æ›´æ–°çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯

### ç”¨æˆ·ä½“éªŒ

- âœ… ç™»å½•ç™»å‡ºåè§†é¢‘æ°¸ä¹…ä¿å­˜ï¼ˆæ•°æ®åº“æŒä¹…åŒ–ï¼‰
- âœ… URLæœ‰æ•ˆæœŸå†…æ­£å¸¸æ’­æ”¾
- âœ… URLå¤±æ•ˆåæ˜¾ç¤ºå‹å¥½æç¤º
- âœ… å¯é‡æ–°ç”Ÿæˆå¤±æ•ˆçš„è§†é¢‘

### æŠ€æœ¯ä¿éšœ

- âœ… å®Œæ•´çš„æ•°æ®æµï¼šäº‘é›¾â†’æ•°æ®åº“â†’å‰ç«¯
- âœ… è‡ªåŠ¨åŒ–è¿‡æœŸæ£€æµ‹æœºåˆ¶
- âœ… çŠ¶æ€ç®¡ç†é—­ç¯
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°

---

**éƒ¨ç½²å®Œæˆï¼è§†é¢‘æŒä¹…åŒ–é—®é¢˜å·²å½»åº•è§£å†³ï¼** ğŸ‰
