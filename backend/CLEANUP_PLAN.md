# 旧代码清理计划

## 📋 当前状态

- **创建时间**: 2025-12-27
- **重构阶段**: 阶段7已完成
- **main.py行数**: ~3255行
- **备份文件**: `main_legacy.py` (完整备份)

---

## ✅ 已完成的工作

### 新架构模块 (18个文件，3864行代码)

**路由模块 (11个)**:
1. ✅ `routers/health.py` - 健康检查 (1个接口)
2. ✅ `routers/user.py` - 用户管理 (3个接口)
3. ✅ `routers/admin.py` - 管理员管理 (12个接口)
4. ✅ `routers/video.py` - 视频管理 (5个接口)
5. ✅ `routers/product.py` - 商品管理 (5个接口)
6. ✅ `routers/prompt.py` - 提示词管理 (3个接口)
7. ✅ `routers/character.py` - 角色管理 (1个接口)
8. ✅ `routers/project.py` - 项目管理 (2个接口)
9. ✅ `routers/image.py` - 图片处理 (5个接口)
10. ✅ `routers/ai_chat.py` - AI聊天和脚本 (3个接口)
11. ✅ `routers/ai_generation.py` - AI生成服务 (5个接口)

**服务模块 (4个)**:
12. ✅ `services/ai_helper.py` - AI辅助服务
13. ✅ `services/tos_service.py` - TOS对象存储
14. ✅ `services/credit_service.py` - 积分管理
15. ✅ `services/ai_service.py` - AI服务封装

**配置模块 (3个)**:
16. ✅ `config.py` - 配置管理
17. ✅ `utils/api_key_pool.py` - API密钥池
18. ✅ `utils/helpers.py` - 工具函数

**总计**: 49个API接口全部迁移完成

---

## 🗑️ main.py中的旧代码分布

### 1. 已迁移但保留的代码 (~2800行)

**数据模型 (200-450行)**
- ❌ `class Chip, Message, ProjectUpdate, ChatResponse` → 已移至 `routers/ai_chat.py`
- ❌ `class GenerateVideoRequest, VideoTaskRequest` → 已移至 `routers/ai_generation.py`
- ❌ `class ProductInfo, GenerateScriptRequest` → 已移至 `routers/ai_chat.py`
- ⚠️ 建议: 可以删除，但保留供参考

**AI工具函数 (450-700行)**
- ❌ `url_to_base64()` → 已移至 `services/ai_helper.py`
- ❌ `chat_with_ai()` → 已移至 `services/ai_helper.py`
- ❌ `generate_video_with_ai()` → 已移至 `services/ai_helper.py`
- ⚠️ 建议: 可以删除，已有完整备份

**密码加密函数 (700-750行)**
- ❌ `hash_password()` → 已移至 `routers/user.py`
- ❌ `verify_password()` → 已移至 `routers/user.py`
- ⚠️ 建议: 可以删除

**旧路由定义 (800-2800行)**
- ❌ 所有 `@app.post`, `@app.get` 装饰器的函数
- ❌ 包括: 图片上传、聊天、脚本生成、视频生成等
- ⚠️ 建议: 注释掉，1个月后删除

### 2. 需要保留的代码 (~400行)

**核心配置 (1-200行)**
- ✅ 环境变量加载
- ✅ TOS配置
- ✅ AI客户端初始化
- ✅ 保留这部分

**FastAPI应用 (300-400行)**
- ✅ 应用初始化
- ✅ 路由注册 (新架构)
- ✅ 中间件配置
- ✅ 异常处理
- ✅ 保留这部分

**微信支付 (2000-2500行)**
- ✅ 微信支付回调
- ✅ 订单查询
- ✅ 充值接口
- ⚠️ 暂时保留，未迁移

**服务器启动 (3200-3255行)**
- ✅ uvicorn运行配置
- ✅ 保留这部分

---

## 📅 清理时间表

### 阶段1: 立即执行 (已完成 ✅)
**日期**: 2025-12-27

- [x] 创建完整备份 `main_legacy.py`
- [x] 在main.py顶部添加详细注释说明
- [x] 创建此清理计划文档
- [x] 提交到Git

### 阶段2: 1周后 (2026-01-03)
**目标**: 注释已迁移的代码

**操作**:
1. [ ] 注释掉所有已迁移的路由定义 (`@app.post`, `@app.get`)
2. [ ] 添加注释说明新位置
3. [ ] 示例:
   ```python
   # ❌ 已迁移至 routers/ai_chat.py
   # @app.post("/api/chat", response_model=ChatResponse)
   # async def send_chat(req: ChatRequest):
   #     ...
   ```
4. [ ] 测试服务器启动
5. [ ] 提交到Git

**预计减少**: ~1000行

### 阶段3: 2周后 (2026-01-10)
**目标**: 删除重复的数据模型

**操作**:
1. [ ] 删除已移至router模块的Pydantic模型
2. [ ] 删除已移至services的工具函数
3. [ ] 保留微信支付相关代码
4. [ ] 测试服务器启动
5. [ ] 提交到Git

**预计减少**: ~500行

### 阶段4: 1个月后 (2026-01-27)
**目标**: 最终精简

**操作**:
1. [ ] 完全删除注释的旧代码
2. [ ] 重新组织main.py结构
3. [ ] 最终保留:
   - 导入语句 (~50行)
   - 环境配置 (~100行)
   - FastAPI初始化 (~50行)
   - 路由注册 (~50行)
   - 中间件和异常处理 (~30行)
   - 微信支付接口 (~500行，可选迁移)
   - 服务器启动 (~20行)
4. [ ] 全面测试
5. [ ] 提交到Git

**最终目标**: ~300-800行 (取决于是否迁移微信支付)

---

## 🔒 安全措施

### Git历史保护
- ✅ 每次清理前提交
- ✅ 使用语义化提交信息
- ✅ 保留完整的commit历史
- ✅ 随时可以回滚到任何版本

### 备份策略
- ✅ `main_legacy.py` - 完整备份 (永久保留)
- ✅ Git历史 - 每个阶段都有提交
- ✅ 服务器备份 - 部署前备份生产环境

### 测试验证
- [ ] 每次修改后运行服务器
- [ ] 检查所有路由是否正常注册
- [ ] 验证关键接口功能
- [ ] 观察生产环境运行状态

---

## 📊 预期效果

### 清理前
- **文件**: main.py (3255行)
- **状态**: 新旧代码混杂
- **维护**: 困难，重复代码多

### 清理后
- **文件**: main.py (~300-800行)
- **结构**: 清晰，只保留核心
- **维护**: 简单，职责明确

### 架构对比

**清理前**:
```
main.py (3255行)
├── 导入 (50行)
├── 配置 (200行)
├── 数据模型 (300行) ❌ 重复
├── 工具函数 (500行) ❌ 重复
├── 旧路由定义 (2000行) ❌ 重复
├── 微信支付 (500行)
└── 启动代码 (20行)
```

**清理后**:
```
main.py (300-800行)
├── 导入 (50行) ✅
├── 配置 (100行) ✅
├── FastAPI初始化 (50行) ✅
├── 路由注册 (50行) ✅ 调用新模块
├── 中间件 (30行) ✅
├── 微信支付 (500行) ⚠️ 可选迁移
└── 启动代码 (20行) ✅
```

---

## ⚠️ 注意事项

1. **不要急于删除**
   - 新架构需要在生产环境运行至少2周
   - 确认所有功能正常后再清理

2. **保留备份文件**
   - `main_legacy.py` 永久保留
   - 作为参考和应急恢复使用

3. **Git提交规范**
   - 每次清理前后都要提交
   - 使用清晰的commit信息
   - 便于回滚和追溯

4. **生产环境优先**
   - 先在测试环境验证
   - 再部署到生产环境
   - 随时准备回滚方案

5. **微信支付代码**
   - 暂时保留在main.py
   - 功能独立，风险较低
   - 后续可考虑迁移到 `routers/payment.py`

---

## 📝 清理检查清单

### 每次清理前
- [ ] 创建Git提交
- [ ] 备份当前main.py
- [ ] 记录当前行数

### 每次清理中
- [ ] 遵循计划逐步执行
- [ ] 不要一次性删除太多
- [ ] 保留注释说明迁移位置

### 每次清理后
- [ ] 测试服务器启动
- [ ] 检查路由注册日志
- [ ] 验证关键接口
- [ ] 提交到Git
- [ ] 更新此文档

---

## 🎯 最终目标

**main.py的职责** (清理后):
1. ✅ 加载环境配置
2. ✅ 初始化FastAPI应用
3. ✅ 注册所有路由模块
4. ✅ 配置中间件和异常处理
5. ✅ 启动服务器

**不应包含的内容**:
- ❌ 具体的业务逻辑
- ❌ 数据模型定义
- ❌ 路由处理函数
- ❌ 工具函数

**最终代码量**: 300-800行 (简洁、清晰、易维护)

---

## 📞 联系和支持

如有问题或需要调整计划，请随时联系开发团队。

**重要**: 安全第一，渐进式重构，确保系统稳定运行。
