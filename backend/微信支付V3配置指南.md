# 微信支付V3配置指南

## 📋 配置步骤

### 1. 安装依赖

```bash
pip install cryptography==42.0.0
```

或者直接安装所有依赖：

```bash
cd backend
pip install -r requirements.txt
```

---

### 2. 获取微信支付参数

登录 [微信支付商户平台](https://pay.weixin.qq.com/)，获取以下参数：

#### 2.1 AppID（必需）
- 路径：**产品中心 > AppID账号管理**
- 说明：这是V3版本的必需参数（V2版本可以留空）

#### 2.2 商户号（mchid）
- 路径：**账户中心 > 商户信息**
- 示例：`1736760845`

#### 2.3 APIv3密钥（32位）
- 路径：**账户中心 > API安全 > 设置APIv3密钥**
- 说明：32位字符串，需要手动设置
- ⚠️ **注意**：这与V2的API密钥不同，需要单独设置

#### 2.4 商户证书
下载商户API证书：

- 路径：**账户中心 > API安全 > 申请API证书**
- 下载后会得到3个文件：
  - `apiclient_cert.pem` - 商户证书（公钥）
  - `apiclient_key.pem` - 商户私钥 ⭐ **需要这个**
  - `apiclient_cert.p12` - 证书包

将 `apiclient_key.pem` 放到 `backend/` 目录下

#### 2.5 证书序列号
使用微信提供的工具查看证书序列号：

**方法1：使用OpenSSL命令**
```bash
openssl x509 -in apiclient_cert.pem -noout -serial
```

**方法2：在商户平台查看**
- 路径：**账户中心 > API安全 > 查看证书**

---

### 3. 配置 `.env` 文件

编辑 `backend/.env`，添加或修改以下配置：

```env
# ==========================================
# 微信支付配置（V3版本 - Native扫码支付）
# ==========================================
# 微信AppID（必需）
WECHAT_APP_ID=wx1234567890abcdef

# 商户号
WECHAT_MCH_ID=1736760845

# APIv3密钥（32位字符串，在商户平台设置）
WECHAT_API_V3_KEY=your_32_character_api_v3_key_here

# 商户证书序列号（在商户平台查看或使用openssl命令获取）
WECHAT_CERT_SERIAL_NO=1234567890ABCDEF1234567890ABCDEF12345678

# 商户API私钥路径（apiclient_key.pem）
WECHAT_PRIVATE_KEY_PATH=./backend/apiclient_key.pem

# 支付回调通知地址（需要公网可访问）
WECHAT_NOTIFY_URL=https://www.semopic.com/api/wechat/callback

# 商品描述
WECHAT_BODY=Semopic积分充值
```

---

### 4. 验证配置

运行测试脚本验证配置是否正确：

```bash
cd backend
python wechat_pay.py
```

**预期输出：**
```
================================================================================
微信支付V3测试
================================================================================
AppID: wx1234567890abcdef
商户号: 1736760845
证书序列号: 1234567890ABCDEF...
私钥路径: ./backend/apiclient_key.pem
================================================================================

创建测试订单: TEST1734960000

[微信支付V3] 创建订单请求: TEST1734960000, 金额: 1分
[微信支付V3] 请求头: {...}
[微信支付V3] 请求体: {...}
[微信支付V3] 响应状态码: 200
[微信支付V3] 响应内容: {...}

测试结果: {'success': True, 'code_url': 'weixin://wxpay/bizpayurl?...', 'order_no': 'TEST1734960000'}

✅ 订单创建成功！
二维码链接: weixin://wxpay/bizpayurl?...
请使用微信扫描二维码进行支付测试
```

---

## 🔐 V3版本与V2版本的区别

| 对比项 | V2版本 | V3版本（推荐） |
|--------|--------|----------------|
| **签名算法** | MD5 | RSA-SHA256 |
| **数据格式** | XML | JSON |
| **AppID** | 可选 | 必需 |
| **证书** | 不需要 | 需要商户证书 |
| **安全性** | 较低 | 更高 |
| **回调验证** | 简单签名 | 证书验证+AEAD解密 |

---

## 📝 常见问题

### Q1: 提示"商户证书序列号未配置"？
**A:** 请确保正确设置了 `WECHAT_CERT_SERIAL_NO`，可以使用以下命令查看：
```bash
openssl x509 -in apiclient_cert.pem -noout -serial
```

### Q2: 提示"无法加载商户私钥"？
**A:** 
1. 检查 `apiclient_key.pem` 文件是否存在
2. 检查文件路径是否正确（相对路径或绝对路径）
3. 确认文件权限是否可读

### Q3: API返回401错误？
**A:** 
1. 检查 `WECHAT_APP_ID` 是否正确
2. 检查 `WECHAT_MCH_ID` 是否正确
3. 检查 `WECHAT_CERT_SERIAL_NO` 是否正确
4. 确认私钥文件与商户号匹配

### Q4: 如何测试支付？
**A:** 
1. 运行测试脚本生成二维码链接
2. 使用微信开发工具或真实微信扫码
3. 测试金额建议设置为1分钱

---

## 🚀 部署到生产环境

### 1. 设置正式的回调地址
确保 `WECHAT_NOTIFY_URL` 是公网可访问的HTTPS地址

### 2. 保护私钥文件
- ✅ 将 `apiclient_key.pem` 添加到 `.gitignore`
- ✅ 设置文件权限为只读（chmod 400）
- ✅ 不要将私钥上传到公开仓库

### 3. 配置HTTPS
微信支付回调地址必须使用HTTPS协议

### 4. 实现回调验证
在 `main.py` 中实现 `/api/wechat/callback` 接口，验证微信支付回调

---

## 📚 参考资料

- [微信支付V3开发文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [Native支付API](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_1.shtml)
- [签名验证](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml)
- [回调通知](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_5.shtml)

---

## ✅ 配置完成检查清单

- [ ] 已安装 `cryptography` 依赖
- [ ] 已获取微信AppID
- [ ] 已设置APIv3密钥（32位）
- [ ] 已下载商户证书（apiclient_key.pem）
- [ ] 已获取证书序列号
- [ ] 已配置 `.env` 文件中的所有参数
- [ ] 已运行测试脚本验证配置
- [ ] 已保护私钥文件安全
- [ ] 已设置HTTPS回调地址（生产环境）

---

**如有问题，请参考微信支付官方文档或联系技术支持。**
