# 📧 邮箱验证码配置指南

## 一、配置步骤

### 方案1：使用QQ邮箱（推荐）

#### 1. 获取QQ邮箱SMTP授权码

1. 登录 [QQ邮箱网页版](https://mail.qq.com)
2. 点击顶部【设置】→【账户】
3. 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
4. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
5. 点击"生成授权码"
6. 发送短信验证后，会显示一个**16位授权码**（例如：abcdabcdabcdabcd）
7. **重要**：这个授权码不是QQ密码！请妥善保存

#### 2. 修改 `.env` 文件

在服务器的 `/root/backend/.env` 文件中修改以下配置：

```bash
# 邮件服务（用于发送验证码）
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=your_qq_email@qq.com          # 替换为您的QQ邮箱
SMTP_PASSWORD=your_16_digit_auth_code    # 替换为上面获取的16位授权码
SENDER_EMAIL=your_qq_email@qq.com        # 发件人邮箱（同上）
SENDER_NAME=SemoPic AI视频平台            # 发件人名称（可自定义）
```

**配置示例**：
```bash
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=123456789@qq.com
SMTP_PASSWORD=abcdabcdabcdabcd
SENDER_EMAIL=123456789@qq.com
SENDER_NAME=SemoPic AI视频平台
```

---

### 方案2：使用163网易邮箱

#### 1. 开启SMTP服务

1. 登录 [163邮箱](https://mail.163.com)
2. 设置 → POP3/SMTP/IMAP
3. 开启"IMAP/SMTP服务"或"POP3/SMTP服务"
4. 点击"授权密码管理"→"新增授权密码"
5. 输入手机验证码后获得授权密码

#### 2. 配置文件

```bash
SMTP_HOST=smtp.163.com
SMTP_PORT=25
SMTP_USER=your_email@163.com
SMTP_PASSWORD=your_auth_password
SENDER_EMAIL=your_email@163.com
SENDER_NAME=SemoPic AI视频平台
```

---

### 方案3：使用企业邮箱（阿里云、腾讯云等）

#### 阿里云企业邮箱
```bash
SMTP_HOST=smtp.qiye.aliyun.com
SMTP_PORT=465
SMTP_USER=your_email@yourdomain.com
SMTP_PASSWORD=your_email_password
SENDER_EMAIL=your_email@yourdomain.com
SENDER_NAME=SemoPic AI视频平台
```

#### 腾讯企业邮箱
```bash
SMTP_HOST=smtp.exmail.qq.com
SMTP_PORT=465
SMTP_USER=your_email@yourdomain.com
SMTP_PASSWORD=your_email_password
SENDER_EMAIL=your_email@yourdomain.com
SENDER_NAME=SemoPic AI视频平台
```

---

## 二、部署到服务器

### 1. 上传配置文件

```bash
# 从本地上传 .env 文件到服务器
scp backend\.env root@115.190.137.87:/root/backend/
```

### 2. 重启后端服务

```bash
# SSH 连接服务器
ssh root@115.190.137.87

# 进入后端目录
cd /root/backend

# 重启服务
pkill -f 'python.*main.py' && sleep 2 && nohup python3 main.py > logs/backend.log 2>&1 &

# 查看日志确认启动成功
tail -50 logs/backend.log
```

---

## 三、测试验证码功能

### 1. 测试注册流程

1. 访问网站：https://semopic.com/app
2. 点击"注册"按钮
3. 输入邮箱地址
4. 点击"发送验证码"
5. 检查邮箱是否收到验证码邮件
6. 输入验证码完成注册

### 2. 查看后端日志

```bash
# 查看最新日志
ssh root@115.190.137.87 "tail -100 /root/backend/logs/backend.log | grep -A 5 '验证码'"
```

**成功日志示例**：
```
[邮件] 验证码已发送到 user@example.com
[验证码] user@example.com: 123456
```

### 3. 如果邮件未配置

- 验证码会打印在后端日志中
- 可以直接从日志中查看验证码进行测试
- 建议尽快配置正式的SMTP服务

---

## 四、常见问题

### Q1: 验证码发送失败怎么办？

**检查步骤**：
1. 确认SMTP配置正确（主机、端口、用户名、授权码）
2. 查看后端日志中的错误信息
3. 确认QQ邮箱的SMTP服务已开启
4. 检查服务器是否能访问SMTP服务器（防火墙）

### Q2: 为什么收不到验证码邮件？

**可能原因**：
1. 邮件被放入垃圾箱 → 检查垃圾箱
2. SMTP授权码错误 → 重新生成授权码
3. 发件频率过高 → QQ邮箱有发送频率限制，等待几分钟再试

### Q3: 端口选择（587 vs 465）

- **587端口**：使用STARTTLS加密，推荐使用
- **465端口**：使用SSL加密
- QQ邮箱两个端口都支持，推荐使用587

### Q4: 如何查看详细的SMTP错误信息？

修改 `backend/main.py` 中的邮件发送函数，添加详细日志：

```python
def send_verification_email(email: str, code: str):
    try:
        # ... 发送邮件代码 ...
        print(f"[邮件] 验证码已发送到 {email}")
        return True
    except Exception as e:
        print(f"[邮件] 发送失败: {e}")
        import traceback
        traceback.print_exc()  # 打印完整错误堆栈
        return False
```

---

## 五、安全建议

1. **不要将 `.env` 文件提交到Git仓库**
   - 已添加到 `.gitignore` 中
   - SMTP密码是敏感信息

2. **定期更换SMTP授权码**
   - 建议每3-6个月更换一次

3. **限制验证码发送频率**
   - 当前代码已实现60秒倒计时
   - 建议在后端也添加IP限制

4. **验证码有效期**
   - 当前设置为10分钟
   - 可根据需要调整（在 `main.py` 中修改）

---

## 六、快速配置命令（QQ邮箱示例）

```bash
# 1. 编辑本地 .env 文件
# 将以下内容替换为您的真实信息：
# SMTP_USER=your_qq_email@qq.com
# SMTP_PASSWORD=your_16_digit_auth_code
# SENDER_EMAIL=your_qq_email@qq.com

# 2. 上传到服务器
scp backend\.env root@115.190.137.87:/root/backend/

# 3. 重启服务
ssh root@115.190.137.87 "cd /root/backend && pkill -f 'python.*main.py' && sleep 2 && nohup python3 main.py > logs/backend.log 2>&1 &"

# 4. 查看日志
ssh root@115.190.137.87 "tail -50 /root/backend/logs/backend.log"
```

---

## 七、联系支持

如有问题，请查看：
- 后端日志：`/root/backend/logs/backend.log`
- 邮箱服务商帮助文档
- QQ邮箱帮助：https://service.mail.qq.com/

完成配置后，用户注册时将收到专业的验证码邮件！🎉
