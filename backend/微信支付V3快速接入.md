# 微信支付V3快速接入指南

## 🚀 快速开始（5步完成）

### 步骤1: 安装依赖

```bash
cd backend
pip install cryptography==42.0.0
```

---

### 步骤2: 准备微信支付证书

1. 登录 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **账户中心 > API安全 > 申请API证书**
3. 下载证书压缩包，解压后得到 `apiclient_key.pem`
4. 将 `apiclient_key.pem` 复制到 `backend/` 目录

```bash
cp /path/to/apiclient_key.pem c:/Users/Administrator/Desktop/AIvdeo/backend/
```

---

### 步骤3: 获取证书序列号

**方法1：使用OpenSSL命令**
```bash
openssl x509 -in apiclient_cert.pem -noout -serial
```

**方法2：在商户平台查看**
- 路径：**账户中心 > API安全 > 查看证书**

---

### 步骤4: 配置环境变量

编辑 `backend/.env` 文件，填写以下参数：

```env
# 微信AppID（必需，在微信公众平台或开放平台获取）
WECHAT_APP_ID=wx1234567890abcdef

# 商户号（已有）
WECHAT_MCH_ID=1736760845

# APIv3密钥（32位，在商户平台设置）
WECHAT_API_V3_KEY=your_32_character_api_v3_key_here

# 证书序列号（步骤3获取）
WECHAT_CERT_SERIAL_NO=1234567890ABCDEF1234567890ABCDEF12345678

# 私钥路径（步骤2放置的文件）
WECHAT_PRIVATE_KEY_PATH=./backend/apiclient_key.pem

# 回调地址（已有）
WECHAT_NOTIFY_URL=https://www.semopic.com/api/wechat/callback
```

⚠️ **重要参数说明：**
- `WECHAT_APP_ID`: 这是V3版本必需的参数，需要在微信公众平台或开放平台创建应用后获取
- `WECHAT_API_V3_KEY`: 这是32位的APIv3密钥，与V2的API密钥不同，需要在商户平台单独设置

---

### 步骤5: 运行测试

```bash
cd backend
python test_wechat_v3.py
```

**预期输出：**
```
================================================================================
  检查环境变量配置
================================================================================
✅ 微信AppID (WECHAT_APP_ID): wx123456...
✅ 商户号 (WECHAT_MCH_ID): 1736760845
✅ APIv3密钥 (WECHAT_API_V3_KEY): your_32...key_here
✅ 证书序列号 (WECHAT_CERT_SERIAL_NO): 1234567...12345678
✅ 私钥路径 (WECHAT_PRIVATE_KEY_PATH): ./backend/apiclient_key.pem
✅ 回调地址 (WECHAT_NOTIFY_URL): https://www.semopic.com/api/wechat/callback

================================================================================
  检查cryptography依赖
================================================================================
✅ cryptography已安装，版本: 42.0.0

================================================================================
  检查商户私钥文件
================================================================================
✅ 私钥文件存在: ./backend/apiclient_key.pem
✅ 私钥格式正确（PEM格式）

================================================================================
  测试签名生成
================================================================================
✅ 私钥加载成功
✅ 签名生成成功
   签名示例: MEUCIQDqK3...

是否测试创建真实订单（1分钱）？[y/N]: y

================================================================================
  测试创建订单（1分钱）
================================================================================
订单号: TEST1734960123
[微信支付V3] 创建订单请求: TEST1734960123, 金额: 1分
✅ 订单创建成功！
   二维码链接: weixin://wxpay/bizpayurl?...

================================================================================
  测试完成
================================================================================
✅ 所有配置正确，可以正常使用微信支付V3！
```

---

## 📝 常见问题

### Q1: 如何获取微信AppID？

**方法1：使用公众号AppID**
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **设置与开发 > 基本配置**
3. 查看"开发者ID(AppID)"

**方法2：使用开放平台AppID**
1. 登录 [微信开放平台](https://open.weixin.qq.com/)
2. 进入 **管理中心 > 网站应用/移动应用**
3. 创建应用并获取AppID

**方法3：Native支付专用AppID**
- 如果商户平台有绑定AppID，可以直接使用
- 进入商户平台 > **产品中心 > AppID账号管理** 查看

### Q2: 如何设置APIv3密钥？

1. 登录 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **账户中心 > API安全 > 设置APIv3密钥**
3. 按照提示设置32位密钥（建议使用随机生成的强密码）
4. 设置完成后，将密钥填入 `.env` 文件的 `WECHAT_API_V3_KEY`

⚠️ **注意**：APIv3密钥与API密钥（V2）是不同的，需要单独设置。

### Q3: 测试时返回401错误？

**原因**：认证失败，可能是以下原因之一：
- AppID错误
- 商户号错误
- 证书序列号错误
- 私钥文件不匹配

**解决方法**：
1. 运行 `python test_wechat_v3.py` 检查所有配置
2. 确认证书是从对应商户号下载的
3. 确认AppID已在商户平台关联

### Q4: 提示"私钥格式错误"？

**解决方法**：
1. 确认下载的是 `apiclient_key.pem`（不是 `apiclient_cert.pem`）
2. 打开文件检查是否包含 `-----BEGIN PRIVATE KEY-----`
3. 如果是p12格式，需要转换为pem格式：

```bash
openssl pkcs12 -in apiclient_cert.p12 -nocerts -out apiclient_key.pem -nodes
```

---

## ✅ 配置完成检查清单

使用以下清单确认所有步骤已完成：

- [ ] 已安装 `cryptography==42.0.0`
- [ ] 已下载商户证书 `apiclient_key.pem`
- [ ] 已将私钥文件放到 `backend/` 目录
- [ ] 已获取微信AppID
- [ ] 已设置APIv3密钥（32位）
- [ ] 已获取证书序列号
- [ ] 已配置 `.env` 文件中所有参数
- [ ] 已运行测试脚本并通过
- [ ] 已测试创建订单（1分钱）
- [ ] 已用微信扫码测试支付（可选）

---

## 🎯 下一步

配置完成后，可以：

1. **在前端集成支付功能**
   - 修改 `RechargeModal.tsx` 组件
   - 调用后端API创建订单
   - 展示二维码供用户扫码支付

2. **实现支付回调**
   - 在 `main.py` 中添加 `/api/wechat/callback` 接口
   - 验证微信支付回调签名
   - 更新用户积分

3. **测试完整流程**
   - 前端发起充值请求
   - 后端创建订单并返回二维码
   - 用户扫码支付
   - 微信回调通知支付结果
   - 后端更新用户积分

---

## 📚 相关文档

- [微信支付V3配置指南.md](./微信支付V3配置指南.md) - 详细配置说明
- [wechat_pay.py](./wechat_pay.py) - 微信支付V3实现代码
- [test_wechat_v3.py](./test_wechat_v3.py) - 配置测试脚本

---

**如有问题，请查看详细配置指南或参考微信支付官方文档。**
